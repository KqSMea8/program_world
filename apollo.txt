ã€ŠApollo æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Appã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Clusterã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Namespaceã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal å…³è” Namespaceã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Itemã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal æ‰¹é‡å˜æ›´ Itemã€‹
ã€ŠApollo æºç è§£æ â€”â€” Admin Service é”å®š Namespaceã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal å‘å¸ƒé…ç½®ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Admin Service å‘é€ ReleaseMessageã€‹
ã€ŠApollo æºç è§£æ â€”â€” Config Service é€šçŸ¥é…ç½®å˜åŒ–ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Config Service é…ç½®è¯»å–æ¥å£ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Client è½®è¯¢é…ç½®ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Config Service è®°å½• Instanceã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»ºç°åº¦ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal é…ç½®ç°åº¦è§„åˆ™ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal ç°åº¦å‘å¸ƒã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal ç°åº¦å…¨é‡å‘å¸ƒã€‹
ã€ŠApollo æºç è§£æ â€”â€” æœåŠ¡è‡ªèº«é…ç½® ServerConfigã€‹
ã€ŠApollo æºç è§£æ â€”â€” Config Service æ“ä½œå®¡è®¡æ—¥å¿— Auditã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal è®¤è¯ä¸æˆæƒï¼ˆä¸€ï¼‰ä¹‹è®¤è¯ã€‹
ã€ŠApollo æºç è§£æ â€”â€” Portal è®¤è¯ä¸æˆæƒï¼ˆäºŒï¼‰ä¹‹æˆæƒã€‹
ã€ŠApollo æºç è§£æ â€”â€” OpenAPI è®¤è¯ä¸æˆæƒï¼ˆä¸€ï¼‰ä¹‹è®¤è¯ã€‹
ã€ŠApollo æºç è§£æ â€”â€” OpenAPI è®¤è¯ä¸æˆæƒï¼ˆäºŒï¼‰ä¹‹æˆæƒã€‹
ã€ŠApollo æºç è§£æ â€”â€” æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯ API é…ç½®ï¼ˆä¸€ï¼‰ä¹‹ä¸€è§ˆã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯ API é…ç½®ï¼ˆäºŒï¼‰ä¹‹ Configã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯ API é…ç½®ï¼ˆä¸‰ï¼‰ä¹‹ ConfigFileã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯ API é…ç½®ï¼ˆå››ï¼‰ä¹‹ ConfigRepositoryã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯é…ç½® Spring é›†æˆï¼ˆä¸€ï¼‰ä¹‹ XML é…ç½®ã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯é…ç½® Spring é›†æˆï¼ˆäºŒï¼‰ä¹‹æ³¨è§£é…ç½®ã€‹
ã€ŠApollo æºç è§£æ â€”â€” å®¢æˆ·ç«¯é…ç½® Spring é›†æˆï¼ˆä¸‰ï¼‰ä¹‹å¤–éƒ¨åŒ–é…ç½®ã€‹

1. æ¦‚è¿°
2. App
2.1 BaseEntity
2.2 ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥
3. Portal ä¾§
3.1 AppController
3.2 AppService
3.3 AppRepository
3.4 AppCreationEvent
3.5 AdminServiceAPI
4. Admin Service ä¾§
4.1 AppController
4.2 AdminService
4.3 AppService
4.4 AppRepository
666. å½©è›‹




æœ¬æ–‡åˆ†äº« Portal åˆ›å»º App çš„æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠ Portalã€Admin Service ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š


ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ App çš„å®ä½“ç»“æ„

è€è‰¿è‰¿ï¼šå› ä¸º Portal æ˜¯ç®¡ç†åå°ï¼Œæ‰€ä»¥ä»ä»£ç å®ç°ä¸Šï¼Œå’Œä¸šåŠ¡ç³»ç»Ÿéå¸¸ç›¸åƒã€‚ä¹Ÿå› æ­¤ï¼Œæœ¬æ–‡ä¼šç•¥æ˜¾å•°å—¦ã€‚

2. App
åœ¨ apollo-common é¡¹ç›®ä¸­ï¼Œ com.ctrip.framework.apollo.common.entity.App ï¼Œç»§æ‰¿ BaseEntity æŠ½è±¡ç±»ï¼Œåº”ç”¨ä¿¡æ¯å®ä½“ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Entity
@Table(name = "App")
@SQLDelete(sql = "Update App set isDeleted = 1 where id = ?")
@Where(clause = "isDeleted = 0")
public class App extends BaseEntity {


    @Column(name = "Name", nullable = false)
    private String name;

    @Column(name = "AppId", nullable = false)
    private String appId;

    @Column(name = "OrgId", nullable = false)
    private String orgId;

    @Column(name = "OrgName", nullable = false)
    private String orgName;

    @Column(name = "OwnerName", nullable = false)
    private String ownerName;

    @Column(name = "OwnerEmail", nullable = false)
    private String ownerEmail;
}
ORM é€‰ç”¨ Hibernate æ¡†æ¶ã€‚
@SQLDelete(...) + @Where(...) æ³¨è§£ï¼Œé…åˆ BaseEntity.extends å­—æ®µï¼Œå®ç° App çš„é€»è¾‘åˆ é™¤ã€‚
å­—æ®µæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚
2.1 BaseEntity
com.ctrip.framework.apollo.common.entity.BaseEntity ï¼ŒåŸºç¡€å®ä½“æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

@MappedSuperclass
@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
public abstract class BaseEntity {


    @Id
    @GeneratedValue
    @Column(name = "Id")
    private long id;

    @Column(name = "IsDeleted", columnDefinition = "Bit default '0'")
    protected boolean isDeleted = false;

    @Column(name = "DataChange_CreatedBy", nullable = false)
    private String dataChangeCreatedBy;

    @Column(name = "DataChange_CreatedTime", nullable = false)
    private Date dataChangeCreatedTime;

    @Column(name = "DataChange_LastModifiedBy")
    private String dataChangeLastModifiedBy;

    @Column(name = "DataChange_LastTime")
    private Date dataChangeLastModifiedTime;


    @PrePersist
    protected void prePersist() {
        if (this.dataChangeCreatedTime == null) dataChangeCreatedTime = new Date();
        if (this.dataChangeLastModifiedTime == null) dataChangeLastModifiedTime = new Date();
    }


    @PreUpdate
    protected void preUpdate() {
        this.dataChangeLastModifiedTime = new Date();
    }


    @PreRemove
    protected void preRemove() {
        this.dataChangeLastModifiedTime = new Date();
    }

    // ... çœç•¥ setting / getting æ–¹æ³•
}
@MappedSuperclass æ³¨è§£ï¼Œè§ ã€ŠHibernate ä¸­ @MappedSuperclass æ³¨è§£çš„ä½¿ç”¨è¯´æ˜ã€‹ æ–‡ç« ã€‚
@Inheritance(...) æ³¨è§£ï¼Œè§ ã€ŠHibernateï¼ˆ11ï¼‰æ˜ å°„ç»§æ‰¿å…³ç³»äºŒä¹‹æ¯ä¸ªç±»å¯¹åº”ä¸€å¼ è¡¨ï¼ˆ@Inheritance(strategy=InheritanceType.TABLE_PER_CLASSï¼‰ã€‹ æ–‡ç« ã€‚
id å­—æ®µï¼Œç¼–å·ï¼ŒLong å‹ï¼Œå…¨å±€è‡ªå¢ã€‚
isDeleted å­—æ®µï¼Œæ˜¯å¦åˆ é™¤ï¼Œç”¨äºé€»è¾‘åˆ é™¤çš„åŠŸèƒ½ã€‚
dataChangeCreatedBy å’Œ dataChangeCreatedTime å­—æ®µï¼Œå®ç°æ•°æ®çš„åˆ›å»ºäººå’Œæ—¶é—´çš„è®°å½•ï¼Œæ–¹ä¾¿è¿½è¸ªã€‚
dataChangeLastModifiedBy å’Œ dataChangeLastModifiedTime å­—æ®µï¼Œå®ç°æ•°æ®çš„æ›´æ–°äººå’Œæ—¶é—´çš„è®°å½•ï¼Œæ–¹ä¾¿è¿½è¸ªã€‚
@PrePersistã€@PreUpdateã€@PreRemove æ³¨è§£ï¼ŒCRD æ“ä½œå‰ï¼Œè®¾ç½®å¯¹åº”çš„æ—¶é—´å­—æ®µã€‚
åœ¨ Apollo ä¸­ï¼Œæ‰€æœ‰å®ä½“éƒ½ä¼šç»§æ‰¿ BaseEntity ï¼Œå®ç°å…¬ç”¨å­—æ®µçš„ç»Ÿä¸€å®šä¹‰ã€‚è¿™ç§è®¾è®¡å€¼å¾—å€Ÿé‰´ï¼Œç‰¹åˆ«æ˜¯åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´è¿™ä¸¤ä¸ªå­—æ®µï¼Œç‰¹åˆ«é€‚åˆçº¿ä¸Šè¿½è¸ªé—®é¢˜å’Œæ•°æ®åŒæ­¥ã€‚
2.2 ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥
åœ¨æ–‡åˆçš„æµç¨‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° App åˆ›å»ºæ—¶ï¼Œåœ¨ Portal Service å­˜å‚¨å®Œæˆåï¼Œä¼šå¼‚æ­¥åŒæ­¥åˆ° Admin Service ä¸­ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨ Apollo çš„æ¶æ„ä¸­ï¼Œä¸€ä¸ªç¯å¢ƒ( Env ) å¯¹åº”ä¸€å¥— Admin Service å’Œ Config Service ã€‚
è€Œ Portal Service ä¼šç®¡ç†æ‰€æœ‰ç¯å¢ƒ( Env ) ã€‚å› æ­¤ï¼Œæ¯æ¬¡åˆ›å»º App åï¼Œéœ€è¦è¿›è¡ŒåŒæ­¥ã€‚

æˆ–è€…è¯´ï¼ŒApp åœ¨ Portal Service ä¸­ï¼Œè¡¨ç¤ºéœ€è¦ç®¡ç†çš„ App ã€‚è€Œåœ¨ Admin Service å’Œ Config Service ä¸­ï¼Œè¡¨ç¤ºå­˜åœ¨çš„ App ã€‚

3. Portal ä¾§
3.1 AppController
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.controller.AppController ï¼Œæä¾› App çš„ API ã€‚

åœ¨åˆ›å»ºé¡¹ç›®çš„ç•Œé¢ä¸­ï¼Œç‚¹å‡»ã€æäº¤ã€‘æŒ‰é’®ï¼Œè°ƒç”¨åˆ›å»º App çš„ API ã€‚

åˆ›å»ºé¡¹ç›®

ä»£ç å¦‚ä¸‹ï¼š

 1: @RestController
 2: @RequestMapping("/apps")
 3: public class AppController {
 4:
 5:     @Autowired
 6:     private UserInfoHolder userInfoHolder;
 7:     @Autowired
 8:     private AppService appService;
 9:
12:     @Autowired
13:     private ApplicationEventPublisher publisher;
14:     @Autowired
15:     private RolePermissionService rolePermissionService;
16:
17:
23:     @RequestMapping(value = "", method = RequestMethod.POST)
24:     public App create(@RequestBody AppModel appModel) {
25:         // å°† AppModel è½¬æ¢æˆ App å¯¹è±¡
26:         App app = transformToApp(appModel);
27:         // ä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“
28:         App createdApp = appService.createAppInLocal(app);
29:         // å‘å¸ƒ AppCreationEvent åˆ›å»ºäº‹ä»¶
30:         publisher.publishEvent(new AppCreationEvent(createdApp));
31:         // æˆäºˆ App ç®¡ç†å‘˜çš„è§’è‰²
32:         Set<String> admins = appModel.getAdmins();
33:         if (!CollectionUtils.isEmpty(admins)) {
34:             rolePermissionService.assignRoleToUsers(RoleUtils.buildAppMasterRoleName(createdApp.getAppId()),
35:                     admins, userInfoHolder.getUser().getUserId());
36:         }
37:         // è¿”å› App å¯¹è±¡
38:         return createdApp;
39:     }
40:
41:     // ... çœç•¥å…¶ä»–æ¥å£å’Œå±æ€§
42: }
POST apps æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
com.ctrip.framework.apollo.portal.entity.model.AppModel ï¼ŒApp Model ã€‚åœ¨ com.ctrip.framework.apollo.portal.entity.model åŒ…ä¸‹ï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª Portal ç•Œé¢çš„å¤æ‚è¯·æ±‚å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒAppModel ä¸€æ–¹é¢å¸¦æœ‰åˆ›å»º App å¯¹è±¡éœ€è¦çš„å±æ€§ï¼Œå¦å¤–ä¹Ÿå¸¦æœ‰éœ€è¦æˆæƒç®¡ç†å‘˜çš„ç¼–å·é›†åˆ admins ï¼Œå³å­˜åœ¨è·¨æ¨¡å—çš„æƒ…å†µã€‚
ç¬¬ 26 è¡Œï¼šè°ƒç”¨ #transformToApp(AppModel) æ–¹æ³•ï¼Œå°† AppModel è½¬æ¢æˆ App å¯¹è±¡ã€‚ğŸ™‚ è½¬æ¢æ–¹æ³•å¾ˆç®€å•ï¼Œç‚¹å‡»æ–¹æ³•ï¼Œç›´æ¥æŸ¥çœ‹ã€‚
ç¬¬ 28 è¡Œï¼šè°ƒç”¨ AppService#createAppInLocal(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ° Portal DB æ•°æ®åº“ã€‚åœ¨ ã€Œ3.2 AppServiceã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
ç¬¬ 30 è¡Œï¼šè°ƒç”¨ ApplicationEventPublisher#publishEvent(AppCreationEvent) æ–¹æ³•ï¼Œå‘å¸ƒ com.ctrip.framework.apollo.portal.listener.AppCreationEvent äº‹ä»¶ã€‚
ç¬¬ 31 è‡³ 36 è¡Œï¼šæˆäºˆ App ç®¡ç†å‘˜çš„è§’è‰²ã€‚è¯¦ç»†è§£æï¼Œè§ ã€ŠApollo æºç è§£æ â€”â€” Portal è®¤è¯ä¸æˆæƒï¼ˆäºŒï¼‰ä¹‹æˆæƒã€‹ ã€‚
ç¬¬ 38 è¡Œï¼šè¿”å›åˆ›å»ºçš„ App å¯¹è±¡ã€‚
3.2 AppService
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.service.AppService ï¼Œæä¾› App çš„ Service é€»è¾‘ã€‚

#createAppInLocal(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ° Portal DB æ•°æ®åº“ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Autowired
 2: private UserInfoHolder userInfoHolder;
 3: @Autowired
 4: private AppRepository appRepository;
 5: @Autowired
 6: private AppNamespaceService appNamespaceService;
 7: @Autowired
 8: private RoleInitializationService roleInitializationService;
 9: @Autowired
10: private UserService userService;
11:
12: @Transactional
13: public App createAppInLocal(App app) {
14:     String appId = app.getAppId();
15:     // åˆ¤æ–­ `appId` æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ App å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
16:     App managedApp = appRepository.findByAppId(appId);
17:     if (managedApp != null) {
18:         throw new BadRequestException(String.format("App already exists. AppId = %s", appId));
19:     }
20:     // è·å¾— UserInfo å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸
21:     UserInfo owner = userService.findByUserId(app.getOwnerName());
22:     if (owner == null) {
23:         throw new BadRequestException("Application's owner not exist.");
24:     }
25:     app.setOwnerEmail(owner.getEmail()); // Email
26:     // è®¾ç½® App çš„åˆ›å»ºå’Œä¿®æ”¹äºº
27:     String operator = userInfoHolder.getUser().getUserId();
28:     app.setDataChangeCreatedBy(operator);
29:     app.setDataChangeLastModifiedBy(operator);
30:     // ä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“
31:     App createdApp = appRepository.save(app);
32:     // åˆ›å»º App çš„é»˜è®¤å‘½åç©ºé—´ "application"
33:     appNamespaceService.createDefaultAppNamespace(appId);
34:     // åˆå§‹åŒ– App è§’è‰²
35:     roleInitializationService.initAppRoles(createdApp);
36:     // ã€TODO 6001ã€‘Tracer æ—¥å¿—
37:     Tracer.logEvent(TracerEventType.CREATE_APP, appId);
38:     return createdApp;
39: }
ç¬¬ 15 è‡³ 19 è¡Œï¼šè°ƒç”¨ AppRepository#findByAppId(appId) æ–¹æ³•ï¼Œåˆ¤æ–­ appId æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ App å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
ç¬¬ 20 è‡³ 25 è¡Œï¼šè°ƒç”¨ UserService#findByUserId(userId) æ–¹æ³•ï¼Œè·å¾— com.ctrip.framework.apollo.portal.entity.bo.UserInfo å¯¹è±¡ã€‚com.ctrip.framework.apollo.portal.entity.bo åŒ…ä¸‹ï¼Œè´Ÿè´£è¿”å› Service çš„ä¸šåŠ¡å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒUserInfo åªåŒ…å« com.ctrip.framework.apollo.portal.entity.po.UserPO çš„éƒ¨åˆ†å±æ€§ï¼šuserIdã€usernameã€email ã€‚
ç¬¬ 27 è‡³ 29 è¡Œï¼šè°ƒç”¨ UserInfoHolder#getUser()#getUserId() æ–¹æ³•ï¼Œè·å¾—å½“å‰ç™»å½•ç”¨æˆ·ï¼Œå¹¶è®¾ç½®ä¸º App çš„åˆ›å»ºå’Œä¿®æ”¹äººã€‚å…³äº UserInfoHolder ï¼Œåç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚
ç¬¬ 31 è¡Œï¼šè°ƒç”¨ AppRepository#save(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“ä¸­ã€‚
ç¬¬ 33 è¡Œï¼šè°ƒç”¨ AppNameSpaceService#createDefaultAppNamespace(appId) æ–¹æ³•ï¼Œåˆ›å»º App çš„é»˜è®¤ Namespace (å‘½åç©ºé—´) "application" ã€‚å¯¹äºæ¯ä¸ª App ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªé»˜è®¤ Namespace ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬åœ¨ ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Namespaceã€‹
ç¬¬ 35 è¡Œï¼šåˆå§‹åŒ– App è§’è‰²ã€‚è¯¦è§£è§£æï¼Œè§ ã€ŠApollo æºç è§£æ â€”â€” Portal è®¤è¯ä¸æˆæƒï¼ˆäºŒï¼‰ä¹‹æˆæƒã€‹ ã€‚
ç¬¬ 37 è¡Œï¼šã€TODO 6001ã€‘Tracer æ—¥å¿—
3.3 AppRepository
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.common.entity.App.AppRepository ï¼Œç»§æ‰¿ org.springframework.data.repository.PagingAndSortingRepository æ¥å£ï¼Œæä¾› App çš„æ•°æ®è®¿é—®ï¼Œå³ DAO ã€‚

ä»£ç å¦‚ä¸‹ï¼š

public interface AppRepository extends PagingAndSortingRepository<App, Long> {

  App findByAppId(String appId);

  List<App> findByOwnerName(String ownerName, Pageable page);

  List<App> findByAppIdIn(Set<String> appIds);

}
åŸºäº Spring Data JPA æ¡†æ¶ï¼Œä½¿ç”¨ Hibernate å®ç°ã€‚è¯¦ç»†å‚è§ ã€ŠSpring Data JPAã€Hibernateã€JPA ä¸‰è€…ä¹‹é—´çš„å…³ç³»ã€‹ æ–‡ç« ã€‚

ğŸ™‚ ä¸ç†Ÿæ‚‰ Spring Data JPA çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ ã€ŠSpring Data JPA ä»‹ç»å’Œä½¿ç”¨ã€‹ æ–‡ç« ã€‚

3.4 AppCreationEvent
com.ctrip.framework.apollo.portal.listener.AppCreationEvent ï¼Œå®ç° org.springframework.context.ApplicationEvent æŠ½è±¡ç±»ï¼ŒApp åˆ›å»ºäº‹ä»¶ã€‚

ä»£ç å¦‚ä¸‹ï¼š

public class AppCreationEvent extends ApplicationEvent {

  public AppCreationEvent(Object source) {
    super(source);
  }

  public App getApp() {
    Preconditions.checkState(source != null);
    return (App) this.source;
  }

}
æ„é€ æ–¹æ³•ï¼Œå°† App å¯¹è±¡ä½œä¸ºæ–¹æ³•å‚æ•°ä¼ å…¥ã€‚
#getApp() æ–¹æ³•ï¼Œè·å¾—äº‹ä»¶å¯¹åº”çš„ App å¯¹è±¡ã€‚
3.4.1 CreationListener
com.ctrip.framework.apollo.portal.listener.CreationListener ï¼Œå¯¹è±¡åˆ›å»ºç›‘å¬å™¨ï¼Œç›®å‰ç›‘å¬ AppCreationEvent å’Œ AppNamespaceCreationEvent äº‹ä»¶ã€‚

æˆ‘ä»¬ä»¥ AppCreationEvent ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

 1: @Autowired
 2: private PortalSettings portalSettings;
 3: @Autowired
 4: private AdminServiceAPI.AppAPI appAPI;
 5:
 6: @EventListener
 7: public void onAppCreationEvent(AppCreationEvent event) {
 8:     // å°† App è½¬æˆ AppDTO å¯¹è±¡
 9:     AppDTO appDTO = BeanUtils.transfrom(AppDTO.class, event.getApp());
10:     // è·å¾—æœ‰æ•ˆçš„ Env æ•°ç»„
11:     List<Env> envs = portalSettings.getActiveEnvs();
12:     // å¾ªç¯ Env æ•°ç»„ï¼Œè°ƒç”¨å¯¹åº”çš„ Admin Service çš„ API ï¼Œåˆ›å»º App å¯¹è±¡ã€‚
13:     for (Env env : envs) {
14:         try {
15:             appAPI.createApp(env, appDTO);
16:         } catch (Throwable e) {
17:             logger.error("Create app failed. appId = {}, env = {})", appDTO.getAppId(), env, e);
18:             Tracer.logError(String.format("Create app failed. appId = %s, env = %s", appDTO.getAppId(), env), e);
19:         }
20:     }
21: }
@EventListener æ³¨è§£ + æ–¹æ³•å‚æ•°ï¼Œè¡¨ç¤º #onAppCreationEvent(...) æ–¹æ³•ï¼Œç›‘å¬ AppCreationEvent äº‹ä»¶ã€‚ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ ã€ŠSpring 4.2æ¡†æ¶ä¸­æ³¨é‡Šé©±åŠ¨çš„äº‹ä»¶ç›‘å¬å™¨è¯¦è§£ã€‹ æ–‡ç« ã€‚
ç¬¬ 9 è¡Œï¼šè°ƒç”¨ BeanUtils#transfrom(Class<T> clazz, Object src) æ–¹æ³•ï¼Œå°† App è½¬æ¢æˆ com.ctrip.framework.apollo.common.dto.AppDTO å¯¹è±¡ã€‚com.ctrip.framework.apollo.common.dto åŒ…ä¸‹ï¼Œæä¾› Controller å’Œ Service å±‚çš„æ•°æ®ä¼ è¾“ã€‚ğŸ˜ˆ ç¬”è€…æ€è€ƒäº†ä¸‹ï¼ŒApollo ä¸­ï¼ŒModel å’Œ DTO å¯¹è±¡å¾ˆç±»ä¼¼ï¼Œå·®å¼‚ç‚¹åœ¨ Model æ›´ä¾§é‡ UI ç•Œé¢æäº¤â€œå¤æ‚â€ä¸šåŠ¡è¯·æ±‚ã€‚å¦å¤– Apollo ä¸­ï¼Œè¿˜æœ‰ VO å¯¹è±¡ï¼Œä¾§é‡ UI ç•Œé¢è¿”å›å¤æ‚ä¸šåŠ¡å“åº”ã€‚æ•´ç†å¦‚ä¸‹å›¾ï¼šå„ç§ Entity æ•´ç†
è€è‰¿è‰¿è®¤ä¸ºï¼ŒPO å¯¹è±¡ï¼Œå¯ä»¥è€ƒè™‘ä¸æš´éœ²ç»™ Controller å±‚ï¼Œåªåœ¨ Service å’Œ Repository ä¹‹é—´ä¼ é€’å’Œè¿”å›ã€‚
å’Œå½©ç¬”è€å¾äº¤æµäº†ä¸‹ï¼Œå®é™…é¡¹ç›®å¯ä»¥ç®€åŒ–ï¼Œä½¿ç”¨ VO + DTO + PO ã€‚
ç¬¬ 11 è¡Œï¼šè°ƒç”¨ PortalSettings#getActiveEnvs() æ–¹æ³•ï¼Œè·å¾—æœ‰æ•ˆçš„ Env æ•°ç»„ï¼Œä¾‹å¦‚ PROD UAT ç­‰ã€‚åç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«è¯¥æ–¹æ³•ã€‚
ç¬¬ 12 è‡³ 20 è¡Œï¼šå¾ªç¯ Env æ•°ç»„ï¼Œè°ƒç”¨ AppAPI#createApp(Env, AppDTO) æ–¹æ³•ï¼Œè°ƒç”¨å¯¹åº”çš„ Admin Service çš„ API ï¼Œåˆ›å»º App å¯¹è±¡ï¼Œä»è€ŒåŒæ­¥ App åˆ° Config DBã€‚
3.5 AdminServiceAPI
com.ctrip.framework.apollo.portal.api.AdminServiceAPI ï¼ŒAdmin Service API é›†åˆï¼ŒåŒ…å« Admin Service æ‰€æœ‰æ¨¡å— API çš„è°ƒç”¨å°è£…ã€‚ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

ä»£ç 

3.5.1 API
com.ctrip.framework.apollo.portal.api.API ï¼ŒAPI æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

public abstract class API {

  @Autowired
  protected RetryableRestTemplate restTemplate;

}
æä¾›ç»Ÿä¸€çš„ restTemplate çš„å±æ€§æ³¨å…¥ã€‚å¯¹äº RetryableRestTemplate çš„æºç å®ç°ï¼Œæˆ‘ä»¬æ”¾åˆ°åç»­æ–‡ç« åˆ†äº«ã€‚
3.5.2 AppAPI
com.ctrip.framework.apollo.portal.api.AdminServiceAPI.AppAPI ï¼Œå®ç° API æŠ½è±¡ç±»ï¼Œå°è£…å¯¹ Admin Service çš„ App æ¨¡å—çš„ API è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Service
public static class AppAPI extends API {

    public AppDTO loadApp(Env env, String appId) {
        return restTemplate.get(env, "apps/{appId}", AppDTO.class, appId);
    }

    public AppDTO createApp(Env env, AppDTO app) {
        return restTemplate.post(env, "apps", app, AppDTO.class);
    }

    public void updateApp(Env env, AppDTO app) {
        restTemplate.put(env, "apps/{appId}", app, app.getAppId());
    }

}
ä½¿ç”¨ restTemplate ï¼Œè°ƒç”¨å¯¹åº”çš„ API æ¥å£ã€‚
4. Admin Service ä¾§
4.1 AppController
åœ¨ apollo-adminservice é¡¹ç›®ä¸­ï¼Œ com.ctrip.framework.apollo.adminservice.controller.AppController ï¼Œæä¾› App çš„ API ã€‚

#create(AppDTO) æ–¹æ³•ï¼Œåˆ›å»º App ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @RestController
 2: public class AppController {
 3:
 4:     @Autowired
 5:     private AppService appService;
 6:     @Autowired
 7:     private AdminService adminService;
 8:
 9:
15:     @RequestMapping(path = "/apps", method = RequestMethod.POST)
16:     public AppDTO create(@RequestBody AppDTO dto) {
17:         // æ ¡éªŒ appId æ ¼å¼ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸
18:         if (!InputValidator.isValidClusterNamespace(dto.getAppId())) {
19:             throw new BadRequestException(String.format("AppIdæ ¼å¼é”™è¯¯: %s", InputValidator.INVALID_CLUSTER_NAMESPACE_MESSAGE));
20:         }
21:         // å°† AppDTO è½¬æ¢æˆ App å¯¹è±¡
22:         App entity = BeanUtils.transfrom(App.class, dto);
23:         // åˆ¤æ–­ `appId` æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ App å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
24:         App managedEntity = appService.findOne(entity.getAppId());
25:         if (managedEntity != null) {
26:             throw new BadRequestException("app already exist.");
27:         }
28:         // ä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“
29:         entity = adminService.createNewApp(entity);
30:         // å°†ä¿å­˜çš„ App å¯¹è±¡ï¼Œè½¬æ¢æˆ AppDTO è¿”å›
31:         dto = BeanUtils.transfrom(AppDTO.class, entity);
32:         return dto;
33:     }
34:
35:     // ... çœç•¥å…¶ä»–æ¥å£å’Œå±æ€§
36: }
POST apps æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
ç¬¬ 17 è‡³ 20 è¡Œï¼šè°ƒç”¨ InputValidator#isValidClusterNamespace(appId) æ–¹æ³•ï¼Œæ ¡éªŒ appId æ˜¯å¦æ»¡è¶³ "[0-9a-zA-Z_.-]+" æ ¼å¼ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
ç¬¬ 22 è¡Œï¼šè°ƒç”¨ BeanUtils#transfrom(Class<T> clazz, Object src) æ–¹æ³•ï¼Œå°† AppDTO è½¬æ¢æˆ Appå¯¹è±¡ã€‚
ç¬¬ 24 è‡³ 27 è¡Œï¼šè°ƒç”¨ AppService#findOne(appId) æ–¹æ³•ï¼Œåˆ¤æ–­ appId æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ App å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
ç¬¬ 29 è¡Œï¼šè°ƒç”¨ AdminService#createNewApp(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“ã€‚
ç¬¬ 30 è‡³ 32 è¡Œï¼šè°ƒç”¨ BeanUtils#transfrom(Class<T> clazz, Object src) æ–¹æ³•ï¼Œå°†ä¿å­˜çš„ App å¯¹è±¡ï¼Œè½¬æ¢æˆ AppDTO è¿”å›ã€‚
4.2 AdminService
com.ctrip.framework.apollo.biz.service.AdminService ï¼ŒğŸ˜ˆ æ— æ³•å®šä¹‰æ˜¯ä»€ä¹ˆæ¨¡å—çš„ Service ï¼Œç›®å‰ä»…æœ‰ #createNewApp(App) æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

 1: @Service
 2: public class AdminService {
 3:
 4:     @Autowired
 5:     private AppService appService;
 6:     @Autowired
 7:     private AppNamespaceService appNamespaceService;
 8:     @Autowired
 9:     private ClusterService clusterService;
10:     @Autowired
11:     private NamespaceService namespaceService;
12:
13:     @Transactional
14:     public App createNewApp(App app) {
15:         // ä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“
16:         String createBy = app.getDataChangeCreatedBy();
17:         App createdApp = appService.save(app);
18:         String appId = createdApp.getAppId();
19:         // åˆ›å»º App çš„é»˜è®¤å‘½åç©ºé—´ "application"
20:         appNamespaceService.createDefaultAppNamespace(appId, createBy);
21:         // åˆ›å»º App çš„é»˜è®¤é›†ç¾¤ "default"
22:         clusterService.createDefaultCluster(appId, createBy);
23:         // åˆ›å»º Cluster çš„é»˜è®¤å‘½åç©ºé—´
24:         namespaceService.instanceOfAppNamespaces(appId, ConfigConsts.CLUSTER_NAME_DEFAULT, createBy);
25:         return app;
26:     }
27:
28: }
ç¬¬ 15 è‡³ 18 è¡Œï¼šè°ƒç”¨ AppService#save(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“ä¸­ã€‚
ç¬¬ 20 è¡Œï¼šè°ƒç”¨ AppNamespaceService#createDefaultAppNamespace(appId, createBy) æ–¹æ³•ï¼Œåˆ›å»º App çš„é»˜è®¤ Namespace (å‘½åç©ºé—´) "application" ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬åœ¨ ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Namespaceã€‹ è¯¦ç»†è§£æã€‚
========== å¦‚ä¸‹éƒ¨åˆ†ï¼Œæ˜¯ Admin Service ç‹¬æœ‰ ==========
App ä¸‹æœ‰å“ªäº› Cluster ï¼Œåœ¨ Portal ä¸­æ˜¯ä¸è¿›è¡Œä¿å­˜ï¼Œé€šè¿‡ Admin Service API è¯»å–è·å¾—ã€‚
ã€AppNamespaceã€‘ç¬¬ 22 è¡Œï¼šè°ƒç”¨ ClusterService#createDefaultCluster(appId, createBy) æ–¹æ³•ï¼Œåˆ›å»º App çš„é»˜è®¤ Cluster "default" ã€‚åç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚
ã€Namespaceã€‘ç¬¬ 24 è¡Œï¼šè°ƒç”¨ NamespaceService#instanceOfAppNamespaces(appId, createBy) æ–¹æ³•ï¼Œåˆ›å»º Cluster çš„é»˜è®¤å‘½åç©ºé—´ã€‚
4.3 AppService
åœ¨ apollo-biz é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.biz.service.AppService ï¼Œæä¾› App çš„ Service é€»è¾‘ç»™ Admin Service å’Œ Config Service ã€‚

#save(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Autowired
 2: private AppRepository appRepository;
 3: @Autowired
 4: private AuditService auditService;
 5:
 6: @Transactional
 7: public App save(App entity) {
 8:     // åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨ã€‚è‹¥æ˜¯ï¼ŒæŠ›å‡º ServiceException å¼‚å¸¸ã€‚
 9:     if (!isAppIdUnique(entity.getAppId())) {
10:         throw new ServiceException("appId not unique");
11:     }
12:     // ä¿æŠ¤ä»£ç ï¼Œé¿å… App å¯¹è±¡ä¸­ï¼Œå·²ç»æœ‰ id å±æ€§ã€‚
13:     entity.setId(0); // protection
14:     App app = appRepository.save(entity);
15:     // è®°å½• Audit åˆ°æ•°æ®åº“ä¸­
16:     auditService.audit(App.class.getSimpleName(), app.getId(), Audit.OP.INSERT, app.getDataChangeCreatedBy());
17:     return app;
18: }
ç¬¬ 8 è‡³ 11 è¡Œï¼šè°ƒç”¨ #isAppIdUnique(appId) æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨ã€‚è‹¥æ˜¯ï¼ŒæŠ›å‡º ServiceException å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

public boolean isAppIdUnique(String appId) {
    Objects.requireNonNull(appId, "AppId must not be null");
    return Objects.isNull(appRepository.findByAppId(appId));
}
ç¬¬ 13 è¡Œï¼šç½®â€œç©ºâ€ App å¯¹è±¡ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œé¿å… App å¯¹è±¡ä¸­ï¼Œå·²ç»æœ‰ id å±æ€§ã€‚

ç¬¬ 14 è¡Œï¼šè°ƒç”¨ AppRepository#save(App) æ–¹æ³•ï¼Œä¿å­˜ App å¯¹è±¡åˆ°æ•°æ®åº“ä¸­ã€‚
ç¬¬ 16 è¡Œï¼šè®°å½• Audit åˆ°æ•°æ®åº“ä¸­ã€‚
4.4 AppRepository
com.ctrip.framework.apollo.biz.repository.AppRepository ï¼Œç»§æ‰¿ org.springframework.data.repository.PagingAndSortingRepository æ¥å£ï¼Œæä¾› App çš„æ•°æ®è®¿é—® ç»™ Admin Service å’Œ Config Service ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface AppRepository extends PagingAndSortingRepository<App, Long> {

  @Query("SELECT a from App a WHERE a.name LIKE %:name%")
  List<App> findByName(@Param("name") String name);

  App findByAppId(String appId);

}
666. å½©è›‹
æˆ‘ä»¬çŸ¥é“ï¼Œä½†å‡¡æ¶‰åŠè·¨ç³»ç»Ÿçš„åŒæ­¥ï¼Œæ— å¯é¿å…ä¼šæœ‰äº‹åŠ¡çš„é—®é¢˜ï¼Œå¯¹äº App åˆ›å»ºä¹Ÿä¼šç¢°åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š

Portal åœ¨åŒæ­¥ App åˆ° Admin Service æ—¶ï¼Œå‘ç”Ÿç½‘ç»œå¼‚å¸¸ï¼ŒåŒæ­¥å¤±è´¥ã€‚é‚£ä¹ˆæ­¤æ—¶ä¼šå‡ºç°è¯¥ App å­˜åœ¨äº Portal ï¼Œå´ä¸å­˜åœ¨äº Admin Service ä¸­ã€‚
æ–°å¢äº†ä¸€å¥—ç¯å¢ƒ( Env ) ï¼Œä¹Ÿä¼šå¯¼è‡´ Portal å’Œ Admin Service ä¸ä¸€è‡´çš„æƒ…å†µã€‚
é‚£ä¹ˆ Apollo æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼ŸğŸ˜ˆ æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥å…ˆè‡ªå·±ç¿»ç¿»æºç ã€‚å˜¿å˜¿ã€‚


1. æ¦‚è¿°
2. Cluster
3. Portal ä¾§
3.1 ClusterController
3.2 ClusterService
3.3 ClusterAPI
4. Admin Service ä¾§
4.1 ClusterController
4.2 ClusterService
4.3 ClusterRepository
666. å½©è›‹


æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚
æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚
è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤


---------------------


æœ¬æ–‡åˆ†äº« Portal åˆ›å»º Cluster çš„æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠ Portalã€Admin Service ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

æµç¨‹

ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Cluster çš„å®ä½“ç»“æ„

è€è‰¿è‰¿ï¼šå› ä¸º Portal æ˜¯ç®¡ç†åå°ï¼Œæ‰€ä»¥ä»ä»£ç å®ç°ä¸Šï¼Œå’Œä¸šåŠ¡ç³»ç»Ÿéå¸¸ç›¸åƒã€‚ä¹Ÿå› æ­¤ï¼Œæœ¬æ–‡ä¼šç•¥æ˜¾å•°å—¦ã€‚

2. Cluster
com.ctrip.framework.apollo.biz.entity.Cluster ï¼Œç»§æ‰¿ BaseEntity æŠ½è±¡ç±»ï¼ŒCluster å®ä½“ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Entity
@Table(name = "Cluster")
@SQLDelete(sql = "Update Cluster set isDeleted = 1 where id = ?")
@Where(clause = "isDeleted = 0")
public class Cluster extends BaseEntity implements Comparable<Cluster> {


    @Column(name = "Name", nullable = false)
    private String name;

    @Column(name = "AppId", nullable = false)
    private String appId;

    @Column(name = "ParentClusterId", nullable = false)
    private long parentClusterId;
}
appId å­—æ®µï¼ŒApp ç¼–å·ï¼ŒæŒ‡å‘å¯¹åº”çš„ App ã€‚App : Cluster = 1 : N ã€‚
parentClusterId å­—æ®µï¼Œçˆ¶ App ç¼–å·ã€‚ç”¨äºç°åº¦å‘å¸ƒï¼Œåœ¨ ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»ºç°åº¦ã€‹ æœ‰è¯¦ç»†è§£æã€‚
3. Portal ä¾§
3.1 ClusterController
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.controller.ClusterController ï¼Œæä¾› Cluster çš„ API ã€‚

åœ¨åˆ›å»º Clusterçš„ç•Œé¢ä¸­ï¼Œç‚¹å‡»ã€æäº¤ã€‘æŒ‰é’®ï¼Œè°ƒç”¨åˆ›å»º Cluster çš„ API ã€‚

åˆ›å»º Cluster

ä»£ç å¦‚ä¸‹ï¼š

 1: @RestController
 2: public class ClusterController {
 3:
 4:     @Autowired
 5:     private ClusterService clusterService;
 6:     @Autowired
 7:     private UserInfoHolder userInfoHolder;
 8:
 9:     @PreAuthorize(value = "@permissionValidator.hasCreateClusterPermission(#appId)")
10:     @RequestMapping(value = "apps/{appId}/envs/{env}/clusters", method = RequestMethod.POST)
11:     public ClusterDTO createCluster(@PathVariable String appId, @PathVariable String env,
12:                                     @RequestBody ClusterDTO cluster) {
13:         // æ ¡éªŒ ClusterDTO éç©º
14:         checkModel(Objects.nonNull(cluster));
15:         // æ ¡éªŒ ClusterDTO çš„ `appId` å’Œ `name` éç©ºã€‚
16:         RequestPrecondition.checkArgumentsNotEmpty(cluster.getAppId(), cluster.getName());
17:         // æ ¡éªŒ ClusterDTO çš„ `name` æ ¼å¼æ­£ç¡®ã€‚
18:         if (!InputValidator.isValidClusterNamespace(cluster.getName())) {
19:             throw new BadRequestException(String.format("Clusteræ ¼å¼é”™è¯¯: %s", InputValidator.INVALID_CLUSTER_NAMESPACE_MESSAGE));
20:         }
21:         // è®¾ç½® ClusterDTO çš„åˆ›å»ºå’Œä¿®æ”¹äººä¸ºå½“å‰ç®¡ç†å‘˜
22:         String operator = userInfoHolder.getUser().getUserId();
23:         cluster.setDataChangeLastModifiedBy(operator);
24:         cluster.setDataChangeCreatedBy(operator);
25:         // åˆ›å»º Cluster åˆ° Admin Service
26:         return clusterService.createCluster(Env.valueOf(env), cluster);
27:     }
28:
29:     // ... çœç•¥ deleteCluster æ¥å£
30: }
POST apps/{appId}/envs/{env}/cluster æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
@PreAuthorize(...) æ³¨è§£ï¼Œè°ƒç”¨ PermissionValidator#hasCreateClusterPermission(appId,) æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦æœ‰åˆ›å»º Cluster çš„æƒé™ã€‚åç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚
ç¬¬ 14 è¡Œï¼šæ ¡éªŒ ClusterDTO éç©ºã€‚æ³¨æ„ï¼Œæ­¤å¤„ä½¿ç”¨çš„æ¥æ”¶è¯·æ±‚å‚æ•°æ˜¯ ClusterDTO ã€‚
ç¬¬ 16 è¡Œï¼šè°ƒç”¨ RequestPrecondition#checkArgumentsNotEmpty(String... args) æ–¹æ³•ï¼Œæ ¡éªŒ ClusterDTO çš„ appId å’Œ name éç©ºã€‚
ç¬¬ 16 è‡³ 21 è¡Œï¼šè°ƒç”¨ InputValidator#isValidClusterNamespace(name) æ–¹æ³•ï¼Œæ ¡éªŒ ClusterDTO çš„ name æ ¼å¼æ­£ç¡®ï¼Œç¬¦åˆ [0-9a-zA-Z_.-]+" æ ¼å¼ã€‚
ç¬¬ 21 è‡³ 24 è¡Œï¼šè®¾ç½® ClusterDTO çš„åˆ›å»ºå’Œä¿®æ”¹äººä¸ºå½“å‰ç®¡ç†å‘˜ã€‚
ç¬¬ 26 è¡Œï¼šè°ƒç”¨ ClusterService#createCluster(Env, ClusterDTO) æ–¹æ³•ï¼Œåˆ›å»ºå¹¶ä¿å­˜ Cluster åˆ° Admin Service ã€‚åœ¨ ã€Œ3.2 ClusterServiceã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
3.2 ClusterService
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.service.ClusterService ï¼Œæä¾› Cluster çš„ Service é€»è¾‘ã€‚

#createCluster(Env, ClusterDTO) æ–¹æ³•ï¼Œåˆ›å»ºå¹¶ä¿å­˜ Cluster åˆ° Admin Service ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Autowired
 2: private AdminServiceAPI.ClusterAPI clusterAPI;
 3:
 4: public ClusterDTO createCluster(Env env, ClusterDTO cluster) {
 5:     // æ ¹æ® `appId` å’Œ `name` æ ¡éªŒ Cluster çš„å”¯ä¸€æ€§
 6:     if (!clusterAPI.isClusterUnique(cluster.getAppId(), env, cluster.getName())) {
 7:         throw new BadRequestException(String.format("cluster %s already exists.", cluster.getName()));
 8:     }
 9:     // åˆ›å»º Cluster åˆ° Admin Service
10:     ClusterDTO clusterDTO = clusterAPI.create(env, cluster);
11:     // ã€TODO 6001ã€‘Tracer æ—¥å¿—
12:     Tracer.logEvent(TracerEventType.CREATE_CLUSTER, cluster.getAppId(), "0", cluster.getName());
13:     return clusterDTO;
14: }
ç¬¬ 5 è‡³ 8 è¡Œï¼šè°ƒç”¨ ClusterAPI#isClusterUnique(appId, Env, clusterName) æ–¹æ³•ï¼Œæ ¹æ® appId å’Œ name æ ¡éªŒ Cluster çš„å”¯ä¸€æ€§ã€‚æ³¨æ„ï¼Œæ­¤å¤„æ˜¯è¿œç¨‹è°ƒç”¨ Admin Service çš„ API ã€‚
ç¬¬ 10 è¡Œï¼šè°ƒç”¨ ClusterAPI#create(Env, ClusterDTO) æ–¹æ³•ï¼Œåˆ›å»º Cluster åˆ° Admin Service ã€‚
ç¬¬ 12 è¡Œï¼šã€TODO 6001ã€‘Tracer æ—¥å¿—
3.3 ClusterAPI
com.ctrip.framework.apollo.portal.api.ClusterAPI ï¼Œå®ç° API æŠ½è±¡ç±»ï¼Œå°è£…å¯¹ Admin Service çš„ Cluster æ¨¡å—çš„ API è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

ClusterAPI

4. Admin Service ä¾§
4.1 ClusterController
åœ¨ apollo-adminservice é¡¹ç›®ä¸­ï¼Œ com.ctrip.framework.apollo.adminservice.controller.ClusterController ï¼Œæä¾› Cluster çš„ API ã€‚

#create(appId, autoCreatePrivateNamespace, ClusterDTO) æ–¹æ³•ï¼Œåˆ›å»º Cluster ã€‚ä»£ç å¦‚ä¸‹ï¼š

    @RestController
 1: public class ClusterController {
 2:
 3:     @Autowired
 4:     private ClusterService clusterService;
 5:
 6:     @RequestMapping(path = "/apps/{appId}/clusters", method = RequestMethod.POST)
 7:     public ClusterDTO create(@PathVariable("appId") String appId,
 8:                              @RequestParam(value = "autoCreatePrivateNamespace", defaultValue = "true") boolean autoCreatePrivateNamespace,
 9:                              @RequestBody ClusterDTO dto) {
10:         // æ ¡éªŒ ClusterDTO çš„ `name` æ ¼å¼æ­£ç¡®ã€‚
11:         if (!InputValidator.isValidClusterNamespace(dto.getName())) {
12:             throw new BadRequestException(String.format("Clusteræ ¼å¼é”™è¯¯: %s", InputValidator.INVALID_CLUSTER_NAMESPACE_MESSAGE));
13:         }
14:         // å°† ClusterDTO è½¬æ¢æˆ Cluster å¯¹è±¡
15:         Cluster entity = BeanUtils.transfrom(Cluster.class, dto);
16:         // åˆ¤æ–­ `name` åœ¨ App ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ Cluster å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
17:         Cluster managedEntity = clusterService.findOne(appId, entity.getName());
18:         if (managedEntity != null) {
19:             throw new BadRequestException("cluster already exist.");
20:         }
21:         // ä¿å­˜ Cluster å¯¹è±¡ï¼Œå¹¶åˆ›å»ºå…¶ Namespace
22:         if (autoCreatePrivateNamespace) {
23:             entity = clusterService.saveWithInstanceOfAppNamespaces(entity);
24:         // ä¿å­˜ Cluster å¯¹è±¡ï¼Œä¸åˆ›å»ºå…¶ Namespace
25:         } else {
26:             entity = clusterService.saveWithoutInstanceOfAppNamespaces(entity);
27:         }
28:         // å°†ä¿å­˜çš„ Cluster å¯¹è±¡è½¬æ¢æˆ ClusterDTO
29:         dto = BeanUtils.transfrom(ClusterDTO.class, entity);
30:         return dto;
31:     }
32:
33:      // ... çœç•¥å…¶ä»–æ¥å£å’Œå±æ€§
34: }
POST /apps/{appId}/clusters æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
ç¬¬ 10 è‡³ 13 è¡Œï¼šè°ƒç”¨ InputValidator#isValidClusterNamespace(name) æ–¹æ³•ï¼Œæ ¡éªŒ ClusterDTO çš„ name æ ¼å¼æ­£ç¡®ï¼Œç¬¦åˆ [0-9a-zA-Z_.-]+" æ ¼å¼ã€‚
ç¬¬ 15 è¡Œï¼šè°ƒç”¨ BeanUtils#transfrom(Class<T> clazz, Object src) æ–¹æ³•ï¼Œå°† ClusterDTO è½¬æ¢æˆ Cluster å¯¹è±¡ã€‚
ç¬¬ 16 è‡³ 20 è¡Œï¼šè°ƒç”¨ ClusterService#findOne(appId, name) æ–¹æ³•ï¼Œæ ¡éªŒ name åœ¨ App ä¸‹ï¼Œæ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ Cluster å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
ç¬¬ 21 è‡³ 23 è¡Œï¼šè‹¥ autoCreatePrivateNamespace = true æ—¶ï¼Œè°ƒç”¨ ClusterService#saveWithInstanceOfAppNamespaces(Cluster) æ–¹æ³•ï¼Œä¿å­˜ Cluster å¯¹è±¡ï¼Œå¹¶åˆ›å»ºå…¶ Namespace ã€‚
ç¬¬ 24 è‡³ 27 è¡Œï¼šè‹¥ autoCreatePrivateNamespace = false æ—¶ï¼Œè°ƒç”¨ ClusterService#saveWithoutInstanceOfAppNamespaces(Cluster) æ–¹æ³•ï¼Œä¿å­˜ Cluster å¯¹è±¡ï¼Œä¸åˆ›å»ºå…¶ Namespace ã€‚
ç¬¬ 29 è¡Œï¼šè°ƒç”¨ BeanUtils#transfrom(Class<T> clazz, Object src) æ–¹æ³•ï¼Œå°† Cluster è½¬æ¢æˆ ClusterDTO å¯¹è±¡ã€‚
4.2 ClusterService
åœ¨ apollo-biz é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.biz.service.ClusterService ï¼Œæä¾› Cluster çš„ Service é€»è¾‘ç»™ Admin Service å’Œ Config Service ã€‚

#saveWithInstanceOfAppNamespaces(Cluster) æ–¹æ³•ï¼Œä¿å­˜ Cluster å¯¹è±¡ï¼Œå¹¶åˆ›å»ºå…¶ Namespace ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Autowired
 2: private ClusterRepository clusterRepository;
 3: @Autowired
 4: private AuditService auditService;
 5: @Autowired
 6: private NamespaceService namespaceService;
 7:
 8: @Transactional
 9: public Cluster saveWithInstanceOfAppNamespaces(Cluster entity) {
10:     // ä¿å­˜ Cluster å¯¹è±¡
11:     Cluster savedCluster = saveWithoutInstanceOfAppNamespaces(entity);
12:     // åˆ›å»º Cluster çš„ Namespace ä»¬
13:     namespaceService.instanceOfAppNamespaces(savedCluster.getAppId(), savedCluster.getName(), savedCluster.getDataChangeCreatedBy());
14:     return savedCluster;
15: }
ç¬¬ 11 è¡Œï¼šè°ƒç”¨ #saveWithoutInstanceOfAppNamespaces(Cluster) æ–¹æ³•ï¼Œä¿å­˜ Cluster å¯¹è±¡ã€‚
ç¬¬ 13 è¡Œï¼šè°ƒç”¨ NamespaceService#instanceOfAppNamespaces(appId, clusterName, createBy) æ–¹æ³•ï¼Œåˆ›å»º Cluster çš„ Namespace ä»¬ã€‚åœ¨ ã€ŠApollo æºç è§£æ â€”â€” Portal åˆ›å»º Namespaceã€‹ ä¸­ï¼Œæœ‰è¯¦ç»†è§£æã€‚
#saveWithoutInstanceOfAppNamespaces(Cluster) æ–¹æ³•ï¼Œä¿å­˜ Cluster å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Transactional
public Cluster saveWithoutInstanceOfAppNamespaces(Cluster entity) {
    // åˆ¤æ–­ `name` åœ¨ App ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ Cluster å¯¹è±¡ã€‚è‹¥å·²ç»å­˜åœ¨ï¼ŒæŠ›å‡º BadRequestException å¼‚å¸¸ã€‚
    if (!isClusterNameUnique(entity.getAppId(), entity.getName())) {
        throw new BadRequestException("cluster not unique");
    }
    // ä¿å­˜ Cluster å¯¹è±¡åˆ°æ•°æ®åº“
    entity.setId(0);//protection
    Cluster cluster = clusterRepository.save(entity);
    // ã€TODO 6001ã€‘Tracer æ—¥å¿—
    auditService.audit(Cluster.class.getSimpleName(), cluster.getId(), Audit.OP.INSERT, cluster.getDataChangeCreatedBy());
    return cluster;
}
4.3 ClusterRepository
com.ctrip.framework.apollo.biz.repository.ClusterRepository ï¼Œç»§æ‰¿ org.springframework.data.repository.PagingAndSortingRepository æ¥å£ï¼Œæä¾› Cluster çš„æ•°æ®è®¿é—® ç»™ Admin Service å’Œ Config Service ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface ClusterRepository extends PagingAndSortingRepository<Cluster, Long> {

  List<Cluster> findByAppIdAndParentClusterId(String appId, Long parentClusterId);

  List<Cluster> findByAppId(String appId);

  Cluster findByAppIdAndName(String appId, String name);

  List<Cluster> findByParentClusterId(Long parentClusterId);

}

1. æ¦‚è¿°
2. ReleaseService
2.1 publishBranchNamespace
2.2 mergeFromMasterAndPublishBranch
3. åŠ è½½ç°åº¦é…ç½®
3.1 GrayReleaseRulesHolder
3.2 GrayReleaseRuleCache
666. å½©è›‹


ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚
æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚
è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚
1. æ¦‚è¿°
è€è‰¿è‰¿ï¼šæœ¬ç³»åˆ—å‡å®šèƒ–å‹å·²ç»é˜…è¯»è¿‡ ã€ŠApollo å®˜æ–¹ wiki æ–‡æ¡£ã€‹ ï¼Œç‰¹åˆ«æ˜¯ ã€ŠApollo å®˜æ–¹ wiki æ–‡æ¡£ â€”â€” ç°åº¦å‘å¸ƒä½¿ç”¨æŒ‡å—ã€‹ã€‚

ç°åº¦å‘å¸ƒï¼Œå®é™…ä¸Šæ˜¯å­ Namespace ( åˆ†æ”¯ Namespace )å‘å¸ƒ Release ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨çš„æ¥å£å’Œ ã€ŠApollo æºç è§£æ â€”â€” Portal å‘å¸ƒé…ç½®ã€‹ æ˜¯ä¸€æ ·çš„ã€‚

å·®å¼‚ç‚¹ï¼Œåœ¨äº apollo-biz é¡¹ç›®ä¸­ï¼ŒReleaseService#publish(...) æ–¹æ³•ä¸­ï¼Œå¤šäº†ä¸€ä¸ªå¤„ç†ç°åº¦å‘å¸ƒçš„åˆ†æ”¯é€»è¾‘ã€‚

2. ReleaseService
2.1 publishBranchNamespace
#publishBranchNamespace(...) æ–¹æ³•ï¼Œå­ Namespace å‘å¸ƒ Release ã€‚å­ Namespace ä¼šè‡ªåŠ¨ç»§æ‰¿ çˆ¶ Namespace å·²ç»å‘å¸ƒçš„é…ç½®ã€‚è‹¥æœ‰ç›¸åŒçš„é…ç½®é¡¹ï¼Œä½¿ç”¨ å­ Namespace çš„ã€‚é…ç½®å¤„ç†çš„é€»è¾‘ä¸Šï¼Œå’Œå…³è” Namespace æ˜¯ä¸€è‡´çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: private Release publishBranchNamespace(Namespace parentNamespace, Namespace childNamespace,
 2:                                        Map<String, String> childNamespaceItems,
 3:                                        String releaseName, String releaseComment,
 4:                                        String operator, boolean isEmergencyPublish) {
 5:     // è·å¾—çˆ¶ Namespace çš„æœ€åæœ‰æ•ˆ Release å¯¹è±¡
 6:     Release parentLatestRelease = findLatestActiveRelease(parentNamespace);
 7:     // è·å¾—çˆ¶ Namespace çš„é…ç½®é¡¹
 8:     Map<String, String> parentConfigurations = parentLatestRelease != null ? gson.fromJson(parentLatestRelease.getConfigurations(), GsonType.CONFIG) : new HashMap<>();
 9:     // è·å¾—çˆ¶ Namespace çš„ releaseId å±æ€§
10:     long baseReleaseId = parentLatestRelease == null ? 0 : parentLatestRelease.getId();
11:     // åˆå¹¶é…ç½®é¡¹
12:     Map<String, String> childNamespaceToPublishConfigs = mergeConfiguration(parentConfigurations, childNamespaceItems);
13:     // å‘å¸ƒå­ Namespace çš„ Release
14:     return branchRelease(parentNamespace, childNamespace, releaseName, releaseComment,
15:             childNamespaceToPublishConfigs, baseReleaseId, operator,
16:             ReleaseOperation.GRAY_RELEASE, isEmergencyPublish);
17:
18: }
ç¬¬ 5 è‡³ 12 è¡Œï¼šè·å¾—æœ€ç»ˆçš„é…ç½® Map ã€‚

ç¬¬ 6 è¡Œï¼šè°ƒç”¨ #findLatestActiveRelease(parentNamespace) æ–¹æ³•ï¼Œè·å¾—çˆ¶ Namespace çš„æœ€åæœ‰æ•ˆ Release å¯¹è±¡ã€‚
ç¬¬ 8 è¡Œï¼šè·å¾—çˆ¶ Namespace çš„é…ç½® Map ã€‚
ç¬¬ 10 è¡Œï¼šè·å¾—çˆ¶ Namespace çš„ releaseId å±æ€§ã€‚
ç¬¬ 12 è¡Œï¼šè°ƒç”¨ #mergeConfiguration(parentConfigurations, childNamespaceItems) æ–¹æ³•ï¼Œåˆå¹¶çˆ¶å­ Namespace çš„é…ç½® Map ã€‚ä»£ç å¦‚ä¸‹ï¼š

private Map<String, String> mergeConfiguration(Map<String, String> baseConfigurations, Map<String, String> coverConfigurations) {
    Map<String, String> result = new HashMap<>();
    // copy base configuration
    // çˆ¶ Namespace çš„é…ç½®é¡¹
    for (Map.Entry<String, String> entry : baseConfigurations.entrySet()) {
        result.put(entry.getKey(), entry.getValue());
    }
    // update and publish
    // å­ Namespace çš„é…ç½®é¡¹
    for (Map.Entry<String, String> entry : coverConfigurations.entrySet()) {
        result.put(entry.getKey(), entry.getValue());
    }
    // è¿”å›åˆå¹¶åçš„é…ç½®é¡¹
    return result;
}
x
ç¬¬ 14 è¡Œï¼šè°ƒç”¨ #branchRelease(...) æ–¹æ³•ï¼Œå‘å¸ƒå­ Namespace çš„ Release ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: private Release branchRelease(Namespace parentNamespace, Namespace childNamespace,
 2:                               String releaseName, String releaseComment,
 3:                               Map<String, String> configurations, long baseReleaseId,
 4:                               String operator, int releaseOperation, boolean isEmergencyPublish) {
 5:     // è·å¾—çˆ¶ Namespace æœ€åæœ‰æ•ˆçš„ Release å¯¹è±¡
 6:     Release previousRelease = findLatestActiveRelease(childNamespace.getAppId(), childNamespace.getClusterName(), childNamespace.getNamespaceName());
 7:     // è·å¾—çˆ¶ Namespace æœ€åæœ‰æ•ˆçš„ Release å¯¹è±¡çš„ç¼–å·
 8:     long previousReleaseId = previousRelease == null ? 0 : previousRelease.getId();
 9:
10:     // åˆ›å»º Map ï¼Œç”¨äº ReleaseHistory å¯¹è±¡çš„ `operationContext` å±æ€§ã€‚
11:     Map<String, Object> releaseOperationContext = Maps.newHashMap();
12:     releaseOperationContext.put(ReleaseOperationContext.BASE_RELEASE_ID, baseReleaseId);
13:     releaseOperationContext.put(ReleaseOperationContext.IS_EMERGENCY_PUBLISH, isEmergencyPublish);
14:
15:     // åˆ›å»ºå­ Namespace çš„ Release å¯¹è±¡ï¼Œå¹¶ä¿å­˜
16:     Release release = createRelease(childNamespace, releaseName, releaseComment, configurations, operator);
17:
18:     // æ›´æ–° GrayReleaseRule çš„ releaseId å±æ€§
19:     // update gray release rules
20:     GrayReleaseRule grayReleaseRule = namespaceBranchService.updateRulesReleaseId(childNamespace.getAppId(),
21:             parentNamespace.getClusterName(),
22:             childNamespace.getNamespaceName(),
23:             childNamespace.getClusterName(),
24:             release.getId(), operator);
25:
26:     // åˆ›å»º ReleaseHistory å¯¹è±¡ï¼Œå¹¶ä¿å­˜
27:     if (grayReleaseRule != null) {
28:         releaseOperationContext.put(ReleaseOperationContext.RULES, GrayReleaseRuleItemTransformer.batchTransformFromJSON(grayReleaseRule.getRules()));
29:     }
30:     releaseHistoryService.createReleaseHistory(parentNamespace.getAppId(), parentNamespace.getClusterName(),
31:             parentNamespace.getNamespaceName(), childNamespace.getClusterName(),
32:             release.getId(),
33:             previousReleaseId, releaseOperation, releaseOperationContext, operator);
34:     return release;
35: }
ç¬¬ 6 è¡Œï¼šè·å¾—çˆ¶ Namespace æœ€åæœ‰æ•ˆçš„ Release å¯¹è±¡ã€‚
ç¬¬ 8 è¡Œï¼šè·å¾—çˆ¶ Namespace çš„ releaseId å±æ€§ã€‚
ç¬¬ 10 è‡³ 13 è¡Œï¼šåˆ›å»º Map ï¼Œç”¨äº ReleaseHistory å¯¹è±¡çš„ operationContext å±æ€§ã€‚
ç¬¬ 16 è¡Œï¼šè°ƒç”¨ #createRelease(...) æ–¹æ³•ï¼Œåˆ›å»ºå­ Namespace çš„ Release å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚
ç¬¬ 18 è‡³ 24 è¡Œï¼šæ›´æ–° GrayReleaseRule çš„ releaseId å±æ€§åˆ°æ•°æ®åº“ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Transactional
public GrayReleaseRule updateRulesReleaseId(String appId, String clusterName, String namespaceName, String branchName, long latestReleaseId, String operator) {
    // è·å¾—è€çš„ GrayReleaseRule å¯¹è±¡
    GrayReleaseRule oldRules = grayReleaseRuleRepository.findTopByAppIdAndClusterNameAndNamespaceNameAndBranchNameOrderByIdDesc(appId, clusterName, namespaceName, branchName);
    if (oldRules == null) {
        return null;
    }

    // åˆ›å»ºæ–°çš„ GrayReleaseRule å¯¹è±¡
    GrayReleaseRule newRules = new GrayReleaseRule();
    newRules.setBranchStatus(NamespaceBranchStatus.ACTIVE);
    newRules.setReleaseId(latestReleaseId); // update
    newRules.setRules(oldRules.getRules());
    newRules.setAppId(oldRules.getAppId());
    newRules.setClusterName(oldRules.getClusterName());
    newRules.setNamespaceName(oldRules.getNamespaceName());
    newRules.setBranchName(oldRules.getBranchName());
    newRules.setDataChangeCreatedBy(operator); // update
    newRules.setDataChangeLastModifiedBy(operator); // update

    // ä¿å­˜æ–°çš„ GrayReleaseRule å¯¹è±¡
    grayReleaseRuleRepository.save(newRules);
    // åˆ é™¤è€çš„ GrayReleaseRule å¯¹è±¡
    grayReleaseRuleRepository.delete(oldRules);
    return newRules;
}
åˆ é™¤è€çš„ GrayReleaseRule å¯¹è±¡ã€‚
ä¿å­˜æ–°çš„ GrayReleaseRule å¯¹è±¡ã€‚
ç¬¬ 26 è‡³ 33 è¡Œï¼šè°ƒç”¨ ReleaseHistoryService#createReleaseHistory(...) æ–¹æ³•ï¼Œåˆ›å»º ReleaseHistory å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚

2.2 mergeFromMasterAndPublishBranch
æœ¬å°èŠ‚ä¸å±äºæœ¬æ–‡ï¼Œè€ƒè™‘åˆ°å’Œç°åº¦å‘å¸ƒç›¸å…³ï¼Œæ‰€ä»¥æ”¾åœ¨æ­¤å¤„ã€‚

åœ¨çˆ¶ Namespace å‘å¸ƒ Release åï¼Œä¼šè°ƒç”¨ #mergeFromMasterAndPublishBranch(...) æ–¹æ³•ï¼Œè‡ªåŠ¨å°† çˆ¶ Namespace (ä¸»å¹²) åˆå¹¶åˆ°å­ Namespace (åˆ†æ”¯)ï¼Œå¹¶è¿›è¡Œä¸€æ¬¡å­ Namespace çš„å‘å¸ƒã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: private void mergeFromMasterAndPublishBranch(Namespace parentNamespace, Namespace childNamespace,
 2:                                              Map<String, String> parentNamespaceItems,
 3:                                              String releaseName, String releaseComment,
 4:                                              String operator, Release masterPreviousRelease,
 5:                                              Release parentRelease, boolean isEmergencyPublish) {
 6:     // è·å¾—å­ Namespace çš„é…ç½® Map
 7:     // create release for child namespace
 8:     Map<String, String> childReleaseConfiguration = getNamespaceReleaseConfiguration(childNamespace);
 9:     // è·å¾—çˆ¶ Namespace çš„é…ç½® Map
10:     Map<String, String> parentNamespaceOldConfiguration = masterPreviousRelease == null ? null : gson.fromJson(masterPreviousRelease.getConfigurations(), GsonType.CONFIG);
11:
12:     // è®¡ç®—åˆå¹¶æœ€æ–°çˆ¶ Namespace çš„é…ç½® Map åçš„å­ Namespace çš„é…ç½® Map
13:     Map<String, String> childNamespaceToPublishConfigs = calculateChildNamespaceToPublishConfiguration(parentNamespaceOldConfiguration,
14:                     parentNamespaceItems, childNamespace);
15:
16:     // compare
17:     // è‹¥å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡å­ Namespace çš„å‘å¸ƒ
18:     if (!childNamespaceToPublishConfigs.equals(childReleaseConfiguration)) {
19:         branchRelease(parentNamespace, childNamespace, releaseName, releaseComment,
20:                 childNamespaceToPublishConfigs, parentRelease.getId(), operator,
21:                 ReleaseOperation.MASTER_NORMAL_RELEASE_MERGE_TO_GRAY, isEmergencyPublish);
22:     }
23: }
ç¬¬ 8 è¡Œï¼šè°ƒç”¨ #getNamespaceReleaseConfiguration(childNamespace) æ–¹æ³•ï¼Œè·å¾—å­ Namespace çš„æœ€æ–°ä¸”æœ‰æ•ˆçš„ Release çš„é…ç½® Map ã€‚ä»£ç å¦‚ä¸‹ï¼š

private Map<String, String> getNamespaceReleaseConfiguration(Namespace namespace) {
    // è·å¾—æœ€åæœ‰æ•ˆçš„ Release å¯¹è±¡
    Release release = findLatestActiveRelease(namespace);
    Map<String, String> configuration = new HashMap<>();
    // è·å¾—é…ç½® Map
    if (release != null) {
        configuration = new Gson().fromJson(release.getConfigurations(), GsonType.CONFIG);
    }
    return configuration;
}
ç¬¬ 10 è¡Œï¼šè·å¾—çˆ¶ Namespace çš„é…ç½® Map ã€‚

ç¬¬ 12 è‡³ 14 è¡Œï¼šè®¡ç®—åˆå¹¶æœ€æ–°çˆ¶ Namespace çš„é…ç½® Map åï¼Œå­ Namespace çš„é…ç½® Map ã€‚ä»£ç å¦‚ä¸‹ï¼š

// è®¡ç®—åˆå¹¶æœ€æ–°çˆ¶ Namespace çš„é…ç½® Map åçš„å­ Namespace çš„é…ç½® Map
private Map<String, String> calculateChildNamespaceToPublishConfiguration(
        Map<String, String> parentNamespaceOldConfiguration, Map<String, String> parentNamespaceNewConfiguration,
        Namespace childNamespace) {
    // è·å¾—å­ Namespace çš„æœ€åæœ‰æ•ˆçš„ Release å¯¹è±¡
    // first. calculate child namespace modified configs
    Release childNamespaceLatestActiveRelease = findLatestActiveRelease(childNamespace);
    // è·å¾—å­ Namespace çš„é…ç½® Map
    Map<String, String> childNamespaceLatestActiveConfiguration = childNamespaceLatestActiveRelease == null ? null :
            gson.fromJson(childNamespaceLatestActiveRelease.getConfigurations(), GsonType.CONFIG);

    // ä»¥å­ Namespace çš„é…ç½® Map ä¸ºåŸºç¡€ï¼Œè®¡ç®—å‡ºå·®å¼‚çš„ Map
    Map<String, String> childNamespaceModifiedConfiguration = calculateBranchModifiedItemsAccordingToRelease(parentNamespaceOldConfiguration,
            childNamespaceLatestActiveConfiguration);

    // second. append child namespace modified configs to parent namespace new latest configuration
    return mergeConfiguration(parentNamespaceNewConfiguration, childNamespaceModifiedConfiguration);
}

// ä»¥å­ Namespace çš„é…ç½® Map ä¸ºåŸºç¡€ï¼Œè®¡ç®—å‡ºå·®å¼‚çš„ Map
private Map<String, String> calculateBranchModifiedItemsAccordingToRelease(
        Map<String, String> masterReleaseConfigs,
        Map<String, String> branchReleaseConfigs) {
    // å·®å¼‚ Map
    Map<String, String> modifiedConfigs = new HashMap<>();
    // è‹¥å­ Namespace çš„é…ç½® Map ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©º Map
    if (CollectionUtils.isEmpty(branchReleaseConfigs)) {
        return modifiedConfigs;
    }
    // è‹¥çˆ¶ Namespace çš„é…ç½® Map ä¸ºç©ºï¼Œç›´æ¥è¿”å›å­ Namespace çš„é…ç½® Map
    if (CollectionUtils.isEmpty(masterReleaseConfigs)) {
        return branchReleaseConfigs;
    }

    // ä»¥å­ Namespace çš„é…ç½® Map ä¸ºåŸºç¡€ï¼Œè®¡ç®—å‡ºå·®å¼‚çš„ Map
    for (Map.Entry<String, String> entry : branchReleaseConfigs.entrySet()) {
        if (!Objects.equals(entry.getValue(), masterReleaseConfigs.get(entry.getKey()))) { // å¯¹æ¯”
            modifiedConfigs.put(entry.getKey(), entry.getValue());
        }
    }
    return modifiedConfigs;
}
ã€ç¬¬ä¸€æ­¥ã€‘é€»è¾‘çœ‹èµ·æ¥æ¯”è¾ƒå†—é•¿å’Œâ€œç»•â€ã€‚ç®€å•çš„è¯´ï¼Œå­ Namespace çš„é…ç½® Map æ˜¯åŒ…å«è€çš„çˆ¶ Namespace çš„é…ç½® Map ï¼Œæ‰€ä»¥éœ€è¦å‰”é™¤ã€‚ä½†æ˜¯å‘¢ï¼Œå‰”é™¤çš„è¿‡ç¨‹ä¸­ï¼Œåˆéœ€è¦ä¿ç•™å­ Namespace çš„è‡ªå®šä¹‰çš„é…ç½®é¡¹ã€‚è¿™å°±æ˜¯ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œ#calculateBranchModifiedItemsAccordingToRelease(...) çš„é€»è¾‘ã€‚
ã€ç¬¬äºŒæ­¥ã€‘åšå®Œä¸Šé¢çš„æ­¥éª¤åï¼Œå°±å¯ä»¥è°ƒç”¨ #mergeConfiguration(...) æ–¹æ³•ï¼Œåˆå¹¶æ–°çš„çˆ¶ Namespace çš„é…ç½® Map ã€‚
èƒ–å‹å¥½å¥½ç†è§£ä¸‹ã€‚
ç¬¬ 17 è‡³ 22 è¡Œï¼šè‹¥å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™è°ƒç”¨ #branchRelease(...) æ–¹æ³•ï¼Œè¿›è¡Œä¸€æ¬¡å­ Namespace çš„å‘å¸ƒã€‚è¿™å—å°±å’Œ ã€Œ2.1 publishBranchNamespaceã€ ä¸€è‡´äº†ã€‚

ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœªå‘ç”Ÿå˜åŒ–å‘¢ï¼Ÿä¾‹å¦‚ï¼Œçˆ¶ Namespace ä¿®æ”¹é…ç½®é¡¹ timeout: 2000=> 3000 ï¼Œè€Œæ°å¥½å­ Namespace ä¿®æ”¹é…ç½®é¡¹ timeout: 2000=> 3000 å¹¶ä¸”å·²ç»ç°åº¦å‘å¸ƒã€‚
3. åŠ è½½ç°åº¦é…ç½®
åœ¨ ã€ŠApollo æºç è§£æ â€”â€” Config Service é…ç½®è¯»å–æ¥å£ã€‹ ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° AbstractConfigService#findRelease(...) æ–¹æ³•ä¸­ï¼Œä¼šè¯»å–æ ¹æ®å®¢æˆ·ç«¯çš„æƒ…å†µï¼ŒåŒ¹é…æ˜¯å¦æœ‰ç°åº¦ Release ï¼Œä»£ç å¦‚ä¸‹ï¼š

 1:
14: private Release findRelease(String clientAppId, String clientIp, String configAppId, String configClusterName,
15:                             String configNamespace, ApolloNotificationMessages clientMessages) {
16:     // è¯»å–ç°åº¦å‘å¸ƒç¼–å·
17:     Long grayReleaseId = grayReleaseRulesHolder.findReleaseIdFromGrayReleaseRule(clientAppId, clientIp, configAppId, configClusterName, configNamespace);
18:     // è¯»å–ç°åº¦ Release å¯¹è±¡
19:     Release release = null;
20:     if (grayReleaseId != null) {
21:         release = findActiveOne(grayReleaseId, clientMessages);
22:     }
23:     // éç°åº¦ï¼Œè·å¾—æœ€æ–°çš„ï¼Œå¹¶ä¸”æœ‰æ•ˆçš„ Release å¯¹è±¡
24:     if (release == null) {
25:         release = findLatestActiveRelease(configAppId, configClusterName, configNamespace, clientMessages);
26:     }
27:     return release;
28: }
ç¬¬ 17 è¡Œï¼šè°ƒç”¨ GrayReleaseRulesHolder#findReleaseIdFromGrayReleaseRule(...) æ–¹æ³•ï¼Œè¯»å–ç°åº¦å‘å¸ƒç¼–å·ï¼Œå³ GrayReleaseRule.releaseId å±æ€§ã€‚è¯¦ç»†è§£æï¼Œåœ¨ ã€Œ3.1 GrayReleaseRulesHolderã€ ä¸­ã€‚
ç¬¬ 18 è‡³ 22 è¡Œï¼šè°ƒç”¨ #findActiveOne(grayReleaseId, clientMessages) æ–¹æ³•ï¼Œè¯»å–ç°åº¦ Release å¯¹è±¡ã€‚
3.1 GrayReleaseRulesHolder
com.ctrip.framework.apollo.biz.grayReleaseRule.GrayReleaseRulesHolder ï¼Œå®ç° InitializingBean å’Œ ReleaseMessageListener æ¥å£ï¼ŒGrayReleaseRule ç¼“å­˜ Holder ï¼Œç”¨äºæé«˜å¯¹ GrayReleaseRule çš„è¯»å–é€Ÿåº¦ã€‚

3.1.1 æ„é€ æ–¹æ³•
private static final Logger logger = LoggerFactory.getLogger(GrayReleaseRulesHolder.class);

private static final Joiner STRING_JOINER = Joiner.on(ConfigConsts.CLUSTER_NAMESPACE_SEPARATOR);
private static final Splitter STRING_SPLITTER = Splitter.on(ConfigConsts.CLUSTER_NAMESPACE_SEPARATOR).omitEmptyStrings();

@Autowired
private GrayReleaseRuleRepository grayReleaseRuleRepository;
@Autowired
private BizConfig bizConfig;


private int databaseScanInterval;

private ScheduledExecutorService executorService;

//store configAppId+configCluster+configNamespace -> GrayReleaseRuleCache map
private Multimap<String, GrayReleaseRuleCache> grayReleaseRuleCache;

//store clientAppId+clientNamespace+ip -> ruleId map
private Multimap<String, Long> reversedGrayReleaseRuleCache;

// an auto increment version to indicate the age of rules
private AtomicLong loadVersion;

public GrayReleaseRulesHolder() {
    loadVersion = new AtomicLong();
    grayReleaseRuleCache = Multimaps.synchronizedSetMultimap(HashMultimap.create());
    reversedGrayReleaseRuleCache = Multimaps.synchronizedSetMultimap(HashMultimap.create());
    executorService = Executors.newScheduledThreadPool(1, ApolloThreadFactory.create("GrayReleaseRulesHolder", true));
}
ç¼“å­˜ç›¸å…³

GrayReleaseRuleCache ï¼Œèƒ–å‹å…ˆå» ã€Œ3.2 GrayReleaseRuleCacheã€ ï¼Œåœ¨å›è¿‡æ¥ã€‚
grayReleaseRuleCache å±æ€§ï¼Œ GrayReleaseRuleCache ç¼“å­˜ã€‚
KEYï¼š configAppId + configCluster + configNamespace æ‹¼æ¥æˆï¼Œä¸åŒ…å« branchName ã€‚å› ä¸ºæˆ‘ä»¬åœ¨åŒ¹é…ç°åº¦è§„åˆ™æ—¶ï¼Œä¸å…³æ³¨ branchName å±æ€§ã€‚
VALUEï¼šGrayReleaseRuleCache æ•°ç»„ã€‚å› ä¸º branchName ä¸åŒ…å«åœ¨ KEY ä¸­ï¼Œè€ŒåŒä¸€ä¸ª Namespace å¯ä»¥åˆ›å»ºå¤šæ¬¡ç°åº¦( åˆ›å»ºä¸‹ä¸€ä¸ªéœ€è¦å°†å‰ä¸€ä¸ªç°åº¦æ”¾å¼ƒ )ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°±ä¼šå½¢æˆæ•°ç»„ã€‚
reversedGrayReleaseRuleCache å±æ€§ï¼Œåè½¬çš„ GrayReleaseRuleCache ç¼“å­˜ã€‚
KEYï¼šclientAppId + clientNamespace + ip ã€‚æ³¨æ„ï¼Œä¸åŒ…å« clusterName å±æ€§ã€‚å…·ä½“åŸå› ï¼Œæˆ‘ä»¬ä¸‹é¢çš„ #hasGrayReleaseRule(clientAppId, clientIp, namespaceName) æ–¹æ³•ä¸­ï¼Œè¯¦ç»†åˆ†äº«ã€‚
VALUEï¼šGrayReleaseRule çš„ç¼–å·æ•°ç»„ã€‚
ä¸ºä»€ä¹ˆå«åšåè½¬å‘¢ï¼Ÿå› ä¸ºä½¿ç”¨ GrayReleaseRule çš„å…·ä½“å±æ€§ä½œä¸ºé”®ï¼Œè€Œä½¿ç”¨ GrayReleaseRule çš„ç¼–å·ä½œä¸ºå€¼ã€‚
é€šè¿‡å®šæ—¶æ‰«æ + ReleaseMessage è¿‘å®æ—¶é€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜ã€‚
å®šæ—¶ä»»åŠ¡ç›¸å…³

executorService å±æ€§ï¼ŒExecutorService å¯¹è±¡ã€‚
databaseScanInterval å±æ€§ï¼Œæ•°æ®åº“æ‰«æé¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚
loadVersion å±æ€§ï¼ŒåŠ è½½ç‰ˆæœ¬ã€‚
3.1.2 åˆå§‹åŒ–
#afterPropertiesSet() æ–¹æ³•ï¼Œé€šè¿‡ Spring è°ƒç”¨ï¼Œåˆå§‹åŒ– Scan ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Override
  1: public void afterPropertiesSet() throws Exception {
  2:     // ä» ServerConfig ä¸­ï¼Œè¯»å–ä»»åŠ¡çš„å‘¨æœŸé…ç½®
  3:     populateDataBaseInterval();
  4:     // åˆå§‹æ‹‰å– GrayReleaseRuleCache åˆ°ç¼“å­˜
  5:     // force sync load for the first time
  6:     periodicScanRules();
  7:     // å®šæ—¶æ‹‰å– GrayReleaseRuleCache åˆ°ç¼“å­˜
  8:     executorService.scheduleWithFixedDelay(this::periodicScanRules,
  9:             getDatabaseScanIntervalSecond(), getDatabaseScanIntervalSecond(), getDatabaseScanTimeUnit()
 10:     );
 11: }
ç¬¬ 3 è¡Œï¼šè°ƒç”¨ #populateDataBaseInterval() æ–¹æ³•ï¼Œä» ServerConfig ä¸­ï¼Œè¯»å–å®šæ—¶ä»»åŠ¡çš„å‘¨æœŸé…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

private void populateDataBaseInterval() {
    databaseScanInterval = bizConfig.grayReleaseRuleScanInterval(); // "apollo.gray-release-rule-scan.interval" ï¼Œé»˜è®¤ä¸º 60 ã€‚
}
ç¬¬ 6 è¡Œï¼šè°ƒç”¨ #periodicScanRules() æ–¹æ³•ï¼Œåˆå§‹æ‹‰å– GrayReleaseRuleCache åˆ°ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š

private void periodicScanRules() {
    // ã€TODO 6001ã€‘Tracer æ—¥å¿—
    Transaction transaction = Tracer.newTransaction("Apollo.GrayReleaseRulesScanner", "scanGrayReleaseRules");
    try {
        // é€’å¢åŠ è½½ç‰ˆæœ¬å·
        loadVersion.incrementAndGet();
        // ä»æ•°æ®å·åº“ä¸­ï¼Œæ‰«ææ‰€æœ‰ GrayReleaseRules ï¼Œå¹¶åˆå¹¶åˆ°ç¼“å­˜ä¸­
        scanGrayReleaseRules();
        // ã€TODO 6001ã€‘Tracer æ—¥å¿—
        transaction.setStatus(Transaction.SUCCESS);
    } catch (Throwable ex) {
        // ã€TODO 6001ã€‘Tracer æ—¥å¿—
        transaction.setStatus(ex);
        logger.error("Scan gray release rule failed", ex);
    } finally {
        // ã€TODO 6001ã€‘Tracer æ—¥å¿—
        transaction.complete();
    }
}

private void scanGrayReleaseRules() {
    long maxIdScanned = 0;
    boolean hasMore = true;
    // å¾ªç¯é¡ºåºåˆ†æ‰¹åŠ è½½ GrayReleaseRule ï¼Œç›´åˆ°ç»“æŸæˆ–è€…çº¿ç¨‹æ‰“æ–­
    while (hasMore && !Thread.currentThread().isInterrupted()) {
        // é¡ºåºåˆ†æ‰¹åŠ è½½ GrayReleaseRule 500 æ¡
        List<GrayReleaseRule> grayReleaseRules = grayReleaseRuleRepository.findFirst500ByIdGreaterThanOrderByIdAsc(maxIdScanned);
        if (CollectionUtils.isEmpty(grayReleaseRules)) {
            break;
        }
        // åˆå¹¶åˆ° GrayReleaseRule ç¼“å­˜
        mergeGrayReleaseRules(grayReleaseRules);
        // è·å¾—æ–°çš„ maxIdScanned ï¼Œå–æœ€åä¸€æ¡è®°å½•
        int rulesScanned = grayReleaseRules.size();
        maxIdScanned = grayReleaseRules.get(rulesScanned - 1).getId();
        // batch is 500
        // è‹¥æ‹‰å–ä¸è¶³ 500 æ¡ï¼Œè¯´æ˜æ—  GrayReleaseRule äº†
        hasMore = rulesScanned == 500;
    }
}
å¾ªç¯é¡ºåºã€åˆ†æ‰¹åŠ è½½ GrayReleaseRule ï¼Œç›´åˆ°å…¨éƒ¨åŠ è½½å®Œæˆ–è€…çº¿ç¨‹æ‰“æ–­ã€‚
loadVersion å±æ€§ï¼Œé€’å¢åŠ è½½ç‰ˆæœ¬å·ã€‚
è°ƒç”¨ #mergeGrayReleaseRules(List<GrayReleaseRule>) æ–¹æ³•ï¼Œåˆå¹¶ GrayReleaseRule æ•°ç»„ï¼Œåˆ°ç¼“å­˜ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ ã€Œ3.1.4 mergeGrayReleaseRulesã€ ã€‚
ğŸ™‚ å…¶ä»–ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä»£ç æ³¨é‡Šã€‚
ç¬¬ 7 è‡³ 10 è¡Œï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶è°ƒç”¨ #scanGrayReleaseRules() æ–¹æ³•ï¼Œé‡æ–°å…¨é‡æ‹‰å– GrayReleaseRuleCache åˆ°ç¼“å­˜ã€‚
3.1.3 handleMessage
#handleMessage(ReleaseMessage, channel) å®ç°æ–¹æ³•ï¼ŒåŸºäº ReleaseMessage è¿‘å®æ—¶é€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Override
 2: public void handleMessage(ReleaseMessage message, String channel) {
 3:     logger.info("message received - channel: {}, message: {}", channel, message);
 4:     String releaseMessage = message.getMessage();
 5:     // åªå¤„ç† APOLLO_RELEASE_TOPIC çš„æ¶ˆæ¯
 6:     if (!Topics.APOLLO_RELEASE_TOPIC.equals(channel) || Strings.isNullOrEmpty(releaseMessage)) {
 7:         return;
 8:     }
 9:     // è·å¾— appId cluster namespace å‚æ•°
10:     List<String> keys = STRING_SPLITTER.splitToList(releaseMessage);
11:     //message should be appId+cluster+namespace
12:     if (keys.size() != 3) {
13:         logger.error("message format invalid - {}", releaseMessage);
14:         return;
15:     }
16:     String appId = keys.get(0);
17:     String cluster = keys.get(1);
18:     String namespace = keys.get(2);
19:
20:     // è·å¾—å¯¹åº”çš„ GrayReleaseRule æ•°ç»„
21:     List<GrayReleaseRule> rules = grayReleaseRuleRepository.findByAppIdAndClusterNameAndNamespaceName(appId, cluster, namespace);
22:     // åˆå¹¶åˆ° GrayReleaseRule ç¼“å­˜ä¸­
23:     mergeGrayReleaseRules(rules);
24: }
ç¬¬ 5 è‡³ 8 è¡Œï¼šåªå¤„ç† APOLLO_RELEASE_TOPIC çš„æ¶ˆæ¯ã€‚
ç¬¬ 9 è‡³ 18 è¡Œï¼šè·å¾— appId cluster namespace å‚æ•°ã€‚
ç¬¬ 21 è¡Œï¼šè°ƒç”¨ grayReleaseRuleRepository#findByAppIdAndClusterNameAndNamespaceName(appId, cluster, namespace) æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ GrayReleaseRule æ•°ç»„ã€‚
ç¬¬ 23 è¡Œï¼šè°ƒç”¨ #mergeGrayReleaseRules(List<GrayReleaseRule>) æ–¹æ³•ï¼Œåˆå¹¶åˆ° GrayReleaseRule ç¼“å­˜ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ ã€Œ3.1.4 mergeGrayReleaseRulesã€ ã€‚
3.1.4 mergeGrayReleaseRules
#mergeGrayReleaseRules(List<GrayReleaseRule>) æ–¹æ³•ï¼Œåˆå¹¶ GrayReleaseRule åˆ°ç¼“å­˜ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: private void mergeGrayReleaseRules(List<GrayReleaseRule> grayReleaseRules) {
 2:     if (CollectionUtils.isEmpty(grayReleaseRules)) {
 3:         return;
 4:     }
 5:     // !!! æ³¨æ„ï¼Œä¸‹é¢æˆ‘ä»¬è¯´çš„â€œè€â€ï¼ŒæŒ‡çš„æ˜¯å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œä½†æ˜¯å®é™…ä¸ä¸€å®šâ€œè€â€ã€‚
 6:     for (GrayReleaseRule grayReleaseRule : grayReleaseRules) {
 7:         // æ— å¯¹åº”çš„ Release ç¼–å·ï¼Œè®°æœªç°åº¦å‘å¸ƒï¼Œåˆ™æ— è§†
 8:         if (grayReleaseRule.getReleaseId() == null || grayReleaseRule.getReleaseId() == 0) {
 9:             // filter rules with no release id, i.e. never released
10:             continue;
11:         }
12:         // åˆ›å»º `grayReleaseRuleCache` çš„ KEY
13:         String key = assembleGrayReleaseRuleKey(grayReleaseRule.getAppId(), grayReleaseRule.getClusterName(), grayReleaseRule.getNamespaceName());
14:         // ä»ç¼“å­˜ `grayReleaseRuleCache` è¯»å–ï¼Œå¹¶åˆ›å»ºæ•°ç»„ï¼Œé¿å…å¹¶å‘
15:         // create a new list to avoid ConcurrentModificationException
16:         List<GrayReleaseRuleCache> rules = Lists.newArrayList(grayReleaseRuleCache.get(key));
17:         // è·å¾—å­ Namespace å¯¹åº”çš„è€çš„ GrayReleaseRuleCache å¯¹è±¡
18:         GrayReleaseRuleCache oldRule = null;
19:         for (GrayReleaseRuleCache ruleCache : rules) {
20:             if (ruleCache.getBranchName().equals(grayReleaseRule.getBranchName())) {
21:                 oldRule = ruleCache;
22:                 break;
23:             }
24:         }
25:
26:         // å¿½ç•¥ï¼Œè‹¥ä¸å­˜åœ¨è€çš„ GrayReleaseRuleCache ï¼Œå¹¶ä¸”å½“å‰ GrayReleaseRule å¯¹åº”çš„åˆ†æ”¯ä¸å¤„äºæ¿€æ´»( æœ‰æ•ˆ )çŠ¶æ€
27:         // if old rule is null and new rule's branch status is not active, ignore
28:         if (oldRule == null && grayReleaseRule.getBranchStatus() != NamespaceBranchStatus.ACTIVE) {
29:             continue;
30:         }
31:
32:         // è‹¥æ–°çš„ GrayReleaseRule ä¸ºæ–°å¢æˆ–æ›´æ–°ï¼Œè¿›è¡Œç¼“å­˜æ›´æ–°
33:         // use id comparison to avoid synchronization
34:         if (oldRule == null || grayReleaseRule.getId() > oldRule.getRuleId()) {
35:             // æ·»åŠ æ–°çš„ GrayReleaseRuleCache åˆ°ç¼“å­˜ä¸­
36:             addCache(key, transformRuleToRuleCache(grayReleaseRule));
37:             // ç§»é™¤è€çš„ GrayReleaseRuleCache å‡ºç¼“å­˜ä¸­
38:             if (oldRule != null) {
39:                 removeCache(key, oldRule);
40:             }
41:         } else {
42:             // è€çš„ GrayReleaseRuleCache å¯¹åº”çš„åˆ†æ”¯å¤„äºæ¿€æ´»( æœ‰æ•ˆ )çŠ¶æ€ï¼Œæ›´æ–°åŠ è½½ç‰ˆæœ¬å·ã€‚
43:             // ä¾‹å¦‚ï¼Œå®šæ—¶è½®è¯¢ï¼Œæœ‰å¯èƒ½ï¼Œæ—©äº `#handleMessage(...)` æ‹¿åˆ°å¯¹åº”çš„æ–°çš„ GrayReleaseRule è®°å½•ï¼Œé‚£ä¹ˆæ­¤æ—¶è§„åˆ™ç¼–å·æ˜¯ç›¸ç­‰çš„ï¼Œä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶ï¼Œä½†æ˜¯ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚
44:             // å†ä¾‹å¦‚ï¼Œä¸¤æ¬¡å®šæ—¶è½®è¯¢ï¼Œç¬¬äºŒæ¬¡å’Œç¬¬ä¸€æ¬¡çš„è§„åˆ™ç¼–å·æ˜¯ç›¸ç­‰çš„ï¼Œä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶ï¼Œä½†æ˜¯ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚
45:             if (oldRule.getBranchStatus() == NamespaceBranchStatus.ACTIVE) {
46:                 // update load version
47:                 oldRule.setLoadVersion(loadVersion.get());
48:             // ä¿ç•™ä¸¤è½®ï¼Œ
49:             // é€‚ç”¨äºï¼Œ`GrayReleaseRule.branchStatus` ä¸º DELETED æˆ– MERGED çš„æƒ…å†µã€‚
50:             } else if ((loadVersion.get() - oldRule.getLoadVersion()) > 1) {
51:                 // remove outdated inactive branch rule after 2 update cycles
52:                 removeCache(key, oldRule);
53:             }
54:         }
55:     }
56: }
ç¬¬ 5 è¡Œï¼š!!! æ³¨æ„ï¼Œä¸‹é¢æˆ‘ä»¬è¯´çš„â€œè€â€ï¼ŒæŒ‡çš„æ˜¯å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œä½†æ˜¯å®é™…ä¸ä¸€å®šâ€œè€â€ã€‚
ç¬¬ 6 è¡Œï¼šå¾ªç¯ GrayReleaseRule æ•°ç»„ï¼Œåˆå¹¶åˆ°ç¼“å­˜ä¸­ã€‚è¢«ç¼“å­˜åˆ°çš„ GrayReleaseRule å¯¹è±¡ï¼Œæˆ‘ä»¬æˆä¸ºâ€œæ–°â€çš„ã€‚
ç¬¬ 7 è‡³ 11 è¡Œï¼šæ— è§†ï¼Œè‹¥ GrayReleaseRule æ— å¯¹åº”çš„ Release ç¼–å·ï¼Œè¯´æ˜è¯¥å­ Namespace è¿˜æœªç°åº¦å‘å¸ƒã€‚
ç¬¬ 12 è‡³ 24 è¡Œï¼šè·å¾—å­ Namespace å¯¹åº”çš„è€çš„ GrayReleaseRuleCache å¯¹è±¡ã€‚æ­¤å¤„çš„â€œè€â€ï¼ŒæŒ‡çš„æ˜¯ç¼“å­˜ä¸­çš„ã€‚
ç¬¬ 26 è‡³ 30 è¡Œï¼šæ— è§†ï¼Œè‹¥ä¸å­˜åœ¨è€çš„ GrayReleaseRuleCache ï¼Œå¹¶ä¸”å½“å‰ GrayReleaseRule å¯¹åº”çš„åˆ†æ”¯ä¸å¤„äºæ¿€æ´»( ACTIVE æœ‰æ•ˆ )çŠ¶æ€ã€‚
ç¬¬ 32 è‡³ 40 è¡Œï¼šè‹¥æ–°çš„ GrayReleaseRule ä¸ºæ–°å¢æˆ–æ›´æ–°( ç¼–å·æ›´å¤§ )ï¼Œè¿›è¡Œç¼“å­˜æ›´æ–°ï¼Œå¹¶ç§»é™¤è€çš„ GrayReleaseRule å‡ºç¼“å­˜ã€‚
ç¬¬ 36 è¡Œï¼šè°ƒç”¨ transformRuleToRuleCache(GrayReleaseRule) æ–¹æ³•ï¼Œå°† GrayReleaseRule è½¬æ¢æˆ GrayReleaseRuleCache å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ ã€Œ3.1.4.1 transformRuleToRuleCacheã€ ã€‚
ç¬¬ 36 è¡Œï¼šè°ƒç”¨ #addCache(key, GrayReleaseRuleCache) æ–¹æ³•ï¼Œæ·»åŠ æ–°çš„ GrayReleaseRuleCache åˆ°ç¼“å­˜ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ ã€Œ3.1.4.2 addCacheã€ ã€‚
ç¬¬ 37 è‡³ 40 è¡Œï¼šè°ƒç”¨ #remove(key, oldRule) æ–¹æ³•ï¼Œç§»é™¤è€ çš„ GrayReleaseRuleCache å‡ºç¼“å­˜ã€‚è¯¦ç»†è§£æï¼Œè§ ã€Œ3.1.4.3 removeCacheã€ ã€‚
ç¬¬ 42 è‡³ 47 è¡Œï¼šè€çš„ GrayReleaseRuleCache å¯¹åº”çš„åˆ†æ”¯å¤„äºæ¿€æ´»( æœ‰æ•ˆ )çŠ¶æ€ï¼Œæ›´æ–°åŠ è½½ç‰ˆæœ¬å·ã€‚
ä¾‹å¦‚ï¼Œå®šæ—¶è½®è¯¢ï¼Œæœ‰å¯èƒ½ï¼Œæ—©äº #handleMessage(...) æ‹¿åˆ°å¯¹åº”çš„æ–°çš„ GrayReleaseRule è®°å½•ï¼Œé‚£ä¹ˆæ­¤æ—¶è§„åˆ™ç¼–å·æ˜¯ç›¸ç­‰çš„ï¼Œä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶ï¼Œä½†æ˜¯ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚
å†ä¾‹å¦‚ï¼Œä¸¤æ¬¡å®šæ—¶è½®è¯¢ï¼Œç¬¬äºŒæ¬¡å’Œç¬¬ä¸€æ¬¡çš„è§„åˆ™ç¼–å·æ˜¯ç›¸ç­‰çš„ï¼Œä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶ï¼Œä½†æ˜¯ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚
æ€»ç»“ï¼Œåˆ·æ–°æœ‰æ•ˆçš„ GrayReleaseRuleCache å¯¹è±¡çš„ loadVersion ã€‚
ç¬¬ 50 è‡³ 53 è¡Œï¼šè‹¥ GrayReleaseRule.branchStatus ä¸º DELETED æˆ– MERGED çš„æƒ…å†µï¼Œä¿ç•™ä¸¤è½®å®šæ—¶æ‰«æï¼Œåè°ƒç”¨ #remove(key, oldRule) æ–¹æ³•ï¼Œç§»é™¤å‡ºç¼“å­˜ã€‚

ä¾‹å¦‚ï¼Œç°åº¦å…¨é‡å‘å¸ƒæ—¶ï¼Œä¼šæ·»åŠ  GrayReleaseRule.branchStatus ä¸º MERGED åˆ°ç¼“å­˜ä¸­ã€‚ä¿ç•™ä¸¤è½®ï¼Œè¿›è¡Œç§»é™¤å‡ºç¼“å­˜ã€‚
ä¸ºä»€ä¹ˆæ˜¯ä¸¤è½®ï¼Ÿç¬”è€…è¯·æ•™äº†å®‹è€å¸ˆ( Apollo çš„ä½œè€…ä¹‹ä¸€ )ï¼Œè§£ç­”å¦‚ä¸‹ï¼š

è¿™ä¸ªæ˜¯æŠŠå·²ç»inactiveçš„ruleåˆ é™¤ï¼Œè‡³äºä¸ºå•¥ä¿ç•™ä¸¤è½®ï¼Œè¿™ä¸ªå¯èƒ½åªæ˜¯ä¸ªé€‰æ‹©é—®é¢˜

T T ç¬”è€…è¡¨ç¤ºè¿˜æ˜¯ä¸å¤ªæ˜ç™½ï¼Œç»§ç»­æ€è€ƒing ã€‚å¦‚æœæœ‰çŸ¥é“çš„èƒ–å‹ï¼Œçƒ¦è¯·å‘ŠçŸ¥ã€‚
3.1.4.1 transformRuleToRuleCache
#transformRuleToRuleCache(GrayReleaseRule) æ–¹æ³•ï¼Œå°† GrayReleaseRule è½¬æ¢æˆ GrayReleaseRuleCache å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

private GrayReleaseRuleCache transformRuleToRuleCache(GrayReleaseRule grayReleaseRule) {
    // è½¬æ¢å‡º GrayReleaseRuleItemDTO æ•°ç»„
    Set<GrayReleaseRuleItemDTO> ruleItems;
    try {
        ruleItems = GrayReleaseRuleItemTransformer.batchTransformFromJSON(grayReleaseRule.getRules());
    } catch (Throwable ex) {
        ruleItems = Sets.newHashSet();
        Tracer.logError(ex);
        logger.error("parse rule for gray release rule {} failed", grayReleaseRule.getId(), ex);
    }
    // åˆ›å»º GrayReleaseRuleCache å¯¹è±¡ï¼Œå¹¶è¿”å›
    return new GrayReleaseRuleCache(grayReleaseRule.getId(),
            grayReleaseRule.getBranchName(), grayReleaseRule.getNamespaceName(), grayReleaseRule
            .getReleaseId(), grayReleaseRule.getBranchStatus(), loadVersion.get(), ruleItems);
}
3.1.4.2 addCache
#addCache(key, GrayReleaseRuleCache) æ–¹æ³•ï¼Œæ·»åŠ æ–°çš„ GrayReleaseRuleCache åˆ°ç¼“å­˜ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: private void addCache(String key, GrayReleaseRuleCache ruleCache) {
 2:     // æ·»åŠ åˆ° reversedGrayReleaseRuleCache ä¸­
 3:     // ä¸ºä»€ä¹ˆè¿™é‡Œåˆ¤æ–­çŠ¶æ€ï¼Ÿå› ä¸ºåˆ é™¤ç°åº¦ï¼Œæˆ–è€…ç°åº¦å…¨é‡å‘å¸ƒçš„æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ•ˆçš„ï¼Œæ‰€ä»¥ä¸æ·»åŠ åˆ° reversedGrayReleaseRuleCache ä¸­
 4:     if (ruleCache.getBranchStatus() == NamespaceBranchStatus.ACTIVE) {
 5:         for (GrayReleaseRuleItemDTO ruleItemDTO : ruleCache.getRuleItems()) {
 6:             for (String clientIp : ruleItemDTO.getClientIpList()) {
 7:                 reversedGrayReleaseRuleCache.put(assembleReversedGrayReleaseRuleKey(ruleItemDTO.getClientAppId(), ruleCache.getNamespaceName(), clientIp),
 8:                         ruleCache.getRuleId());
 9:             }
10:         }
11:     }
12:     // æ·»åŠ åˆ° grayReleaseRuleCache
13:     // è¿™é‡Œä¸ºä»€ä¹ˆå¯ä»¥æ·»åŠ ï¼Ÿå› ä¸ºæ·»åŠ åˆ° grayReleaseRuleCache ä¸­æ˜¯ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åˆ¤æ–­çŠ¶æ€
14:     grayReleaseRuleCache.put(key, ruleCache);
15: }
ç¬¬ 2 è‡³ 11 è¡Œï¼šæ·»åŠ åˆ° reversedGrayReleaseRuleCache ä¸­ã€‚
ä¸ºä»€ä¹ˆè¿™é‡Œåˆ¤æ–­çŠ¶æ€ï¼Ÿå› ä¸ºåˆ é™¤ç°åº¦ï¼Œæˆ–è€…ç°åº¦å…¨é‡å‘å¸ƒçš„æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ•ˆçš„ï¼Œæ‰€ä»¥ä¸æ·»åŠ åˆ° reversedGrayReleaseRuleCache ä¸­ã€‚
ç¬¬ 14 è¡Œï¼šæ·»åŠ åˆ° grayReleaseRuleCache ä¸­ã€‚
ä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥æ·»åŠ ï¼Ÿå› ä¸ºæ·»åŠ åˆ° grayReleaseRuleCache ä¸­æ˜¯ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åˆ¤æ–­çŠ¶æ€ã€‚
3.1.4.3 removeCache
#remove(key, oldRule) æ–¹æ³•ï¼Œç§»é™¤è€ çš„ GrayReleaseRuleCache å‡ºç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š

private void removeCache(String key, GrayReleaseRuleCache ruleCache) {
    // ç§»é™¤å‡º grayReleaseRuleCache
    grayReleaseRuleCache.remove(key, ruleCache);
    // ç§»é™¤å‡º reversedGrayReleaseRuleCache
    for (GrayReleaseRuleItemDTO ruleItemDTO : ruleCache.getRuleItems()) {
        for (String clientIp : ruleItemDTO.getClientIpList()) {
            reversedGrayReleaseRuleCache.remove(assembleReversedGrayReleaseRuleKey(ruleItemDTO.getClientAppId(), ruleCache.getNamespaceName(), clientIp),
                    ruleCache.getRuleId());
        }
    }
}
3.1.5 findReleaseIdFromGrayReleaseRule
#findReleaseIdFromGrayReleaseRule(clientAppId, clientIp, configAppId, configCluster, configNamespaceName) æ–¹æ³•ï¼Œè‹¥åŒ¹é…ä¸Šç°åº¦è§„åˆ™ï¼Œè¿”å›å¯¹åº”çš„ Release ç¼–å·ã€‚ä»£ç å¦‚ä¸‹ï¼š

public Long findReleaseIdFromGrayReleaseRule(String clientAppId, String clientIp, String
        configAppId, String configCluster, String configNamespaceName) {
    // åˆ¤æ–­ grayReleaseRuleCache ä¸­æ˜¯å¦å­˜åœ¨
    String key = assembleGrayReleaseRuleKey(configAppId, configCluster, configNamespaceName);
    if (!grayReleaseRuleCache.containsKey(key)) {
        return null;
    }
    // å¾ªç¯ GrayReleaseRuleCache æ•°ç»„ï¼Œè·å¾—åŒ¹é…çš„ Release ç¼–å·
    // create a new list to avoid ConcurrentModificationException
    List<GrayReleaseRuleCache> rules = Lists.newArrayList(grayReleaseRuleCache.get(key));
    for (GrayReleaseRuleCache rule : rules) {
        // æ ¡éªŒ GrayReleaseRuleCache å¯¹åº”çš„å­ Namespace çš„çŠ¶æ€æ˜¯å¦ä¸ºæœ‰æ•ˆ
        //check branch status
        if (rule.getBranchStatus() != NamespaceBranchStatus.ACTIVE) {
            continue;
        }
        // æ˜¯å¦åŒ¹é…ç°åº¦è§„åˆ™ã€‚è‹¥æ˜¯ï¼Œåˆ™è¿”å›ã€‚
        if (rule.matches(clientAppId, clientIp)) {
            return rule.getReleaseId();
        }
    }
    return null;
}
ğŸ™‚ ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±çœ‹ä»£ç æ³¨é‡Šå“ˆã€‚
3.1.6 hasGrayReleaseRule

public boolean hasGrayReleaseRule(String clientAppId, String clientIp, String namespaceName) {
    return reversedGrayReleaseRuleCache.containsKey(assembleReversedGrayReleaseRuleKey(clientAppId, namespaceName, clientIp))
            || reversedGrayReleaseRuleCache.containsKey(assembleReversedGrayReleaseRuleKey(clientAppId, namespaceName, GrayReleaseRuleItemDTO.ALL_IP));
}
æˆ‘ä»¬æ¥ç¿»ä¸€ä¸‹è‹±æ–‡æ³¨é‡Šå“ˆï¼Œéç›´è¯‘å“ˆã€‚
ã€ä¸€ã€‘Check whether there are gray release rules for the clientAppId, clientIp, namespace combination. é’ˆå¯¹ clientAppId + clientIp + namespaceName ï¼Œæ ¡éªŒæ˜¯å¦æœ‰ç°åº¦è§„åˆ™ã€‚
ã€äºŒã€‘Please note that even there are gray release rules, it doesnâ€™t mean it will always load gray releases. è¯·æ³¨æ„ï¼Œå³ä½¿è¿”å› true ï¼Œä¹Ÿä¸æ„å‘³ç€è°ƒç”¨æ–¹èƒ½åŠ è½½åˆ°ç°åº¦å‘å¸ƒçš„é…ç½®ã€‚
ã€ä¸‰ã€‘ Because gray release rules actually apply to one more dimension - cluster. å› ä¸ºï¼ŒreversedGrayReleaseRuleCache çš„ KEY ä¸åŒ…å« branchName ï¼Œæ‰€ä»¥ reversedGrayReleaseRuleCache çš„ VALUE ä¸ºå¤šä¸ª branchName çš„ Release ç¼–å·çš„é›†åˆã€‚
é‚£ä¹ˆä¸ºä»€ä¹ˆä¸åŒ…å« branchName å‘¢ï¼Ÿåœ¨ ã€ŠApollo æºç è§£æ â€”â€” Config Service é…ç½®è¯»å–æ¥å£ã€‹ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° AbstractConfigService ä¸­ï¼Œ#loadConfig(...) æ–¹æ³•ä¸­ï¼Œæ˜¯æŒ‰ç…§é›†ç¾¤çš„ä¼˜å…ˆçº§åŠ è½½ï¼Œä»£ç å¦‚ä¸‹ï¼š

@Override
public Release loadConfig(String clientAppId, String clientIp, String configAppId, String configClusterName,
                          String configNamespace, String dataCenter, ApolloNotificationMessages clientMessages) {
    // ä¼˜å…ˆï¼Œè·å¾—æŒ‡å®š Cluster çš„ Release ã€‚è‹¥å­˜åœ¨ï¼Œç›´æ¥è¿”å›ã€‚
    // load from specified cluster fist
    if (!Objects.equals(ConfigConsts.CLUSTER_NAME_DEFAULT, configClusterName)) {
        Release clusterRelease = findRelease(clientAppId, clientIp, configAppId, configClusterName, configNamespace,
                clientMessages);
        if (!Objects.isNull(clusterRelease)) {
            return clusterRelease;
        }
    }

    // å…¶æ¬¡ï¼Œè·å¾—æ‰€å± IDC çš„ Cluster çš„ Release ã€‚è‹¥å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    // try to load via data center
    if (!Strings.isNullOrEmpty(dataCenter) && !Objects.equals(dataCenter, configClusterName)) {
        Release dataCenterRelease = findRelease(clientAppId, clientIp, configAppId, dataCenter, configNamespace, clientMessages);
        if (!Objects.isNull(dataCenterRelease)) {
            return dataCenterRelease;
        }
    }

    // æœ€åï¼Œè·å¾—é»˜è®¤ Cluster çš„ Release ã€‚
    // fallback to default release
    return findRelease(clientAppId, clientIp, configAppId, ConfigConsts.CLUSTER_NAME_DEFAULT, configNamespace, clientMessages);
}
ä½†æ˜¯ï¼Œç¬”è€…åˆæƒ³äº†æƒ³ï¼Œåº”è¯¥ä¹Ÿä¸æ˜¯è¿™ä¸ªæ–¹æ³•çš„åŸå› ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•é‡Œï¼Œæ¯ä¸ªè°ƒç”¨çš„æ–¹æ³•ï¼ŒclusterName æ˜¯æ˜ç¡®çš„ï¼Œé‚£ä¹ˆæŠŠ clusterName èå…¥åˆ°ç¼“å­˜ KEY ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æ‰€ä»¥åº”è¯¥ä¸æ˜¯è¿™ä¸ªåŸå› ã€‚
ç›®å‰ #hasGrayReleaseRule(clientAppId, clientIp, namespaceName) æ–¹æ³•ï¼Œä»…ä»…è¢« ConfigFileController è°ƒç”¨ã€‚è€Œ ConfigFileController åœ¨è°ƒç”¨æ—¶ï¼Œç¡®å®æ˜¯ä¸çŸ¥é“è‡ªå·±ä½¿ç”¨å“ªä¸ª clusterName ã€‚æ©æ©ï¼Œåº”è¯¥æ˜¯è¿™ä¸ªåŸå› ã€‚

3.2 GrayReleaseRuleCache
com.ctrip.framework.apollo.biz.grayReleaseRule.GrayReleaseRuleCache ï¼ŒGrayReleaseRule çš„ç¼“å­˜ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

private long ruleId;

// ç¼ºå°‘ appId
// ç¼ºå°‘ clusterName

private String namespaceName;
private String branchName;
private Set<GrayReleaseRuleItemDTO> ruleItems;
private long releaseId;
private int branchStatus;

private long loadVersion;

// åŒ¹é… clientAppId + clientIp
public boolean matches(String clientAppId, String clientIp) {
    for (GrayReleaseRuleItemDTO ruleItem : ruleItems) {
        if (ruleItem.matches(clientAppId, clientIp)) {
            return true;
        }
    }
    return false;
}

ç›¸æ¯” GrayReleaseRule æ¥è¯´ï¼š

å°‘äº† appId + clusterName å­—æ®µï¼Œå› ä¸ºåœ¨ GrayReleaseRulesHolder ä¸­ï¼Œç¼“å­˜ KEY ä¼šæ ¹æ®éœ€è¦åŒ…å«è¿™ä¸¤ä¸ªå­—æ®µã€‚

å¤šäº† loadVersion å­—æ®µï¼Œç”¨äºè®°å½• GrayReleaseRuleCache çš„åŠ è½½ç‰ˆæœ¬ï¼Œç”¨äºè‡ªåŠ¨è¿‡æœŸé€»è¾‘ã€‚
666. å½©è›‹

T T ï¼ŒGrayReleaseRulesHolder çœ‹çš„è¿˜æ˜¯æœ‰ç‚¹æ‡µé€¼ï¼Œåé¢è‡ªå·±æœ‰æœºä¼šå†™é…ç½®ä¸­å¿ƒçš„ç°åº¦å‘å¸ƒåŠŸèƒ½çš„æ—¶å€™ï¼Œåœ¨æ‰æ‘¸æ‰æ‘¸ã€‚å¦‚æœæœ‰äº›å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚


1. æ¦‚è¿°
2. AuthConfiguration
2.1 SpringSecurityAuthAutoConfiguration
2.2 SpringSecurityConfigureration
3. Users
3.1 UserInfo
4. Authorities
5. UserService
5.1 SpringSecurityUserService
5.2 UserInfoController
6. UserInfoHolder
6.1 SpringSecurityUserInfoHolder
7. SsoHeartbeatHandler
7.1 DefaultSsoHeartbeatHandler
7.2 SsoHeartbeatController
8. LogoutHandler
8.1 DefaultLogoutHandler


RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚
æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚
è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

1. æ¦‚è¿°

è€è‰¿è‰¿ï¼šæœ¬ç³»åˆ—å‡å®šèƒ–å‹å·²ç»é˜…è¯»è¿‡ ã€ŠApollo å®˜æ–¹ wiki æ–‡æ¡£ã€‹ ï¼Œç‰¹åˆ«æ˜¯ ã€ŠPortal å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ã€‹ ã€‚

æœ¬æ–‡åˆ†äº« Portal çš„è®¤è¯ä¸æˆæƒï¼Œä¾§é‡åœ¨è®¤è¯éƒ¨åˆ†ã€‚

åœ¨ ã€ŠPortal å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ã€‹ æ–‡æ¡£çš„å¼€å¤´ï¼š

Apollo æ˜¯é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œä¼šæä¾›æƒé™ç®¡ç†ï¼ˆAuthorizationï¼‰ï¼Œç†è®ºä¸Šæ˜¯ä¸è´Ÿè´£ç”¨æˆ·ç™»å½•è®¤è¯åŠŸèƒ½çš„å®ç°ï¼ˆAuthenticationï¼‰ã€‚

æ‰€ä»¥ Apollo å®šä¹‰äº†ä¸€äº›SPIç”¨æ¥è§£è€¦ï¼ŒApollo æ¥å…¥ç™»å½•çš„å…³é”®å°±æ˜¯å®ç°è¿™äº› SPI ã€‚

å’Œæˆ‘ä»¬ç†è§£çš„ JDK SPI ä¸åŒï¼ŒApollo æ˜¯åŸºäº Spring Profile çš„ç‰¹æ€§ï¼Œé…åˆä¸Š Spring Java Configuration å®ç°äº†ç±»ä¼¼ SPI çš„åŠŸèƒ½ã€‚å¯¹äºå¤§å¤šæ•°äººï¼Œæˆ‘ä»¬å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„æ˜¯ï¼ŒåŸºäºä¸åŒçš„ Profile åŠ è½½ä¸åŒç¯å¢ƒçš„ yaml æˆ– properties é…ç½®æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œå½“ç¬”è€…çœ‹åˆ°è¿™æ ·çš„ç©æ³•ï¼Œä¹Ÿæ˜¯çœ¼å‰ä¸€äº®ã€‚

åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œspi åŒ…ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®¤è¯ç›¸å…³çš„é…ç½®ä¸å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šä»£ç ç»“æ„

ç»¿æ¡†ï¼šæ¥å£ã€‚
ç´«æ¡†ï¼šå®ç°ã€‚
çº¢æ¡†ï¼šé…ç½®æ¥å£å¯¹åº”çš„å®ç°ã€‚
2. AuthConfiguration
com.ctrip.framework.apollo.portal.spi.configuration.AuthConfiguration ï¼Œè®¤è¯ Spring Java é…ç½®ã€‚å¦‚ä¸‹å›¾ï¼šAuthConfiguration

ç›®å‰æœ‰ä¸‰ç§å®ç°ï¼š

ç¬¬ä¸€ç§ï¼Œ profile=ctrip ï¼Œæºç¨‹å†…éƒ¨å®ç°ï¼Œæ¥å…¥äº†SSOå¹¶å®ç°ç”¨æˆ·æœç´¢ã€æŸ¥è¯¢æ¥å£ã€‚
ç¬¬äºŒç§ï¼Œprofile=auth ï¼Œä½¿ç”¨ Apollo æä¾›çš„ Spring Security ç®€å•è®¤è¯ã€‚
ç¬¬ä¸‰ç§ï¼Œprofile ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å®ç°ï¼Œå…¨å±€åªæœ‰ apollo ä¸€ä¸ªè´¦å·ã€‚
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§ï¼ŒåŸºäº Spring Security çš„å®ç°ã€‚æ‰€ä»¥æœ¬æ–‡ä»…åˆ†äº«è¿™ç§æ–¹å¼ã€‚å¯¹å…¶ä»–æ–¹å¼æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±è¯»ä¸‹ä»£ç å“ˆã€‚

æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼šç±»å›¾

2.1 SpringSecurityAuthAutoConfiguration
UserService ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(UserService.class)
public UserService springSecurityUserService() {
    return new SpringSecurityUserService();
}
ä½¿ç”¨ SpringSecurityUserService å®ç°ç±»ï¼Œåœ¨ ã€Œ5. UserServiceã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
UserInfoHolder ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(UserInfoHolder.class)
public UserInfoHolder springSecurityUserInfoHolder() {
    return new SpringSecurityUserInfoHolder();
}
ä½¿ç”¨ SpringSecurityUserInfoHolder å®ç°ç±»ï¼Œåœ¨ ã€Œ6. UserInfoHolderã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
JdbcUserDetailsManager ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
public JdbcUserDetailsManager jdbcUserDetailsManager(AuthenticationManagerBuilder auth, DataSource datasource) throws Exception {
    JdbcUserDetailsManager jdbcUserDetailsManager = auth.jdbcAuthentication() // åŸºäº JDBC
            .passwordEncoder(new BCryptPasswordEncoder()) // åŠ å¯†æ–¹å¼ä¸º BCryptPasswordEncoder
            .dataSource(datasource) // æ•°æ®æº
            .usersByUsernameQuery("select Username,Password,Enabled from `Users` where Username = ?") // ä½¿ç”¨ Username æŸ¥è¯¢ User
            .authoritiesByUsernameQuery("select Username,Authority from `Authorities` where Username = ?") // ä½¿ç”¨ Username æŸ¥è¯¢ Authorities
            .getUserDetailsService();

    jdbcUserDetailsManager.setUserExistsSql("select Username from `Users` where Username = ?"); // åˆ¤æ–­ User æ˜¯å¦å­˜åœ¨
    jdbcUserDetailsManager.setCreateUserSql("insert into `Users` (Username, Password, Enabled) values (?,?,?)"); // æ’å…¥ User
    jdbcUserDetailsManager.setUpdateUserSql("update `Users` set Password = ?, Enabled = ? where Username = ?"); // æ›´æ–° User
    jdbcUserDetailsManager.setDeleteUserSql("delete from `Users` where Username = ?"); // åˆ é™¤ User
    jdbcUserDetailsManager.setCreateAuthoritySql("insert into `Authorities` (Username, Authority) values (?,?)"); // æ’å…¥ Authorities
    jdbcUserDetailsManager.setDeleteUserAuthoritiesSql("delete from `Authorities` where Username = ?"); // åˆ é™¤ Authorities
    jdbcUserDetailsManager.setChangePasswordSql("update `Users` set Password = ? where Username = ?"); // æ›´æ–° Authorities

    return jdbcUserDetailsManager;
}


org.springframework.security.provisioning.JdbcUserDetailsManager ï¼Œç»§æ‰¿ JdbcDaoImpl çš„åŠŸèƒ½ï¼Œæä¾›äº†ä¸€äº›å¾ˆæœ‰ç”¨çš„ä¸ Users å’Œ Authorities è¡¨ç›¸å…³çš„æ–¹æ³•ã€‚

èƒ–å‹å…ˆçœ‹ä¸‹ ã€Œ3. Usersã€ å’Œ ã€Œ4. Authoritiesã€ å°èŠ‚ï¼Œç„¶åå›è¿‡å¤´ç»§ç»­å¾€ä¸‹çœ‹ã€‚

SsoHeartbeatHandler ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(SsoHeartbeatHandler.class)
public SsoHeartbeatHandler defaultSsoHeartbeatHandler() {
    return new DefaultSsoHeartbeatHandler();
}
ä½¿ç”¨ DefaultSsoHeartbeatHandler å®ç°ç±»ï¼Œåœ¨ ã€Œ7. SsoHeartbeatHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
LogoutHandler ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(LogoutHandler.class)
public LogoutHandler logoutHandler() {
    return new DefaultLogoutHandler();
}
ä½¿ç”¨ DefaultLogoutHandler å®ç°ç±»ï¼Œåœ¨ ã€Œ8. LogoutHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
2.2 SpringSecurityConfigureration
@Order(99)
@Profile("auth")
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
static class SpringSecurityConfigurer extends WebSecurityConfigurerAdapter {

    public static final String USER_ROLE = "user";

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable(); // å…³é—­æ‰“å¼€çš„ csrf ä¿æŠ¤
        http.headers().frameOptions().sameOrigin(); // ä»…å…è®¸ç›¸åŒ origin è®¿é—®
        http.authorizeRequests()
                .antMatchers("/openapi
    @Id
    @GeneratedValue
    @Column(name = "Id")
    private long id;

    @Column(name = "Username", nullable = false)
    private String username;

    @Column(name = "Password", nullable = false)
    private String password;

    @Column(name = "Email", nullable = false)
    private String email;

    @Column(name = "Enabled", nullable = false)
    private int enabled;

}

å­—æ®µæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚

3.1 UserInfo
com.ctrip.framework.apollo.portal.entity.bo.UserInfo ï¼ŒUser BO ã€‚ä»£ç å¦‚ä¸‹ï¼š

public class UserInfo {

    private String userId;


    private String name;


    private String email;


}


åœ¨ UserPO çš„ #toUserInfo() æ–¹æ³•ä¸­ï¼Œå°† UserPO è½¬æ¢æˆ UserBO ï¼Œä»£ç å¦‚ä¸‹ï¼š

public UserInfo toUserInfo() {
    UserInfo userInfo = new UserInfo();
    userInfo.setName(this.getUsername());
    userInfo.setUserId(this.getUsername());
    userInfo.setEmail(this.getEmail());
    return userInfo;
}


æ³¨æ„ï¼ŒuserId å’Œ name å±æ€§ï¼Œéƒ½æ˜¯æŒ‡å‘ User.username ã€‚



4. Authorities


Authorities è¡¨ï¼ŒSpring Security ä¸­çš„ Authority ï¼Œå®é™…å’Œ Role è§’è‰²ç­‰ä»·ã€‚è¡¨ç»“æ„å¦‚ä¸‹

`Id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢Id',

`Username` varchar(50) NOT NULL,

`Authority` varchar(50) NOT NULL,

ç›®å‰ Portal åªæœ‰ä¸€ç§è§’è‰² "ROLE_user" ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šAuthorities

ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„å‘¢ï¼Ÿåœ¨ Apollo ä¸­ï¼Œ

ç»Ÿä¸€çš„ URL çš„æƒé™æ ¡éªŒï¼Œåªåˆ¤æ–­æ˜¯å¦ä¸ºç™»é™†ç”¨æˆ·ï¼Œåœ¨ SpringSecurityConfigureration ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚

å…·ä½“æ¯ä¸ª URL çš„æƒé™æ ¡éªŒï¼Œé€šè¿‡åœ¨å¯¹åº”çš„æ–¹æ³•ä¸Šï¼Œæ·»åŠ  @PreAuthorize æ–¹æ³•æ³¨è§£ï¼Œé…åˆå…·ä½“çš„æ–¹æ³•å‚æ•°ï¼Œä¸€èµ·æ ¡éªŒåŠŸèƒ½ + æ•°æ®çº§çš„æƒé™æ ¡éªŒã€‚


5. UserService

com.ctrip.framework.apollo.portal.spi.UserService ï¼ŒUser æœåŠ¡æ¥å£ï¼Œç”¨æ¥ç»™ Portal æä¾›ç”¨æˆ·æœç´¢ç›¸å…³åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface UserService {

    List<UserInfo> searchUsers(String keyword, int offset, int limit);

    UserInfo findByUserId(String userId);

    List<UserInfo> findByUserIds(List<String> userIds);

}

5.1 SpringSecurityUserService

com.ctrip.framework.apollo.portal.spi.springsecurity.SpringSecurityUserService ï¼ŒåŸºäº Spring Security çš„ UserService å®ç°ç±»ã€‚

5.5.1 æ„é€ æ–¹æ³•

private PasswordEncoder encoder = new BCryptPasswordEncoder();

private List<GrantedAuthority> authorities;

@Autowired
private JdbcUserDetailsManager userDetailsManager;
@Autowired
private UserRepository userRepository;

@PostConstruct
public void init() {
    authorities = new ArrayList<>();
    authorities.add(new SimpleGrantedAuthority("ROLE_user"));
}
authorities å±æ€§ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¸º "ROLE_user" ã€‚

5.5.2 createOrUpdate
#createOrUpdate(UserPO) æ–¹æ³•ï¼Œåˆ›å»ºæˆ–æ›´æ–° User ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Transactional
 2: public void createOrUpdate(UserPO user) {
 3:     String username = user.getUsername();
 4:     // åˆ›å»º Spring Security User
 5:     User userDetails = new User(username, encoder.encode(user.getPassword()), authorities);
 6:     // è‹¥å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ›´æ–°
 7:     if (userDetailsManager.userExists(username)) {
 8:         userDetailsManager.updateUser(userDetails);
 9:     // è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ–°å¢
10:     } else {
11:         userDetailsManager.createUser(userDetails);
12:     }
13:     // æ›´æ–°é‚®ç®±
14:     UserPO managedUser = userRepository.findByUsername(username);
15:     managedUser.setEmail(user.getEmail());
16:     userRepository.save(managedUser);
17: }
ç¬¬ 5 è¡Œï¼šåˆ›å»º com.ctrip.framework.apollo.portal.spi.springsecurity.User å¯¹è±¡ã€‚
ä½¿ç”¨ PasswordEncoder å¯¹ password åŠ å¯†ã€‚
ä¼ å…¥å¯¹åº”çš„è§’è‰² authorities å‚æ•°ã€‚
ç¬¬ 6 è‡³ 12 è¡Œï¼šæ–°å¢æˆ–æ›´æ–° User ã€‚
ç¬¬ 13 è‡³ 16 è¡Œï¼šæ›´æ–° email ã€‚ä¸ç›´æ¥åœ¨ã€ç¬¬ 6 è‡³ 12 è¡Œã€‘å¤„ç†çš„åŸå› æ˜¯ï¼Œcom.ctrip.framework.apollo.portal.spi.springsecurity.User ä¸­æ²¡æœ‰ email å±æ€§ã€‚

5.5.3 å…¶ä»–å®ç°æ–¹æ³•
ğŸ™‚ èƒ–å‹è‡ªå·±æŸ¥çœ‹ä»£ç ã€‚å˜¿å˜¿ã€‚

5.2 UserInfoController

åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.controller.UserInfoController ï¼Œæä¾› User çš„ API ã€‚

5.2.1 createOrUpdateUser

åœ¨ç”¨æˆ·ç®¡ç†çš„ç•Œé¢ä¸­ï¼Œç‚¹å‡»ã€æäº¤ã€‘æŒ‰é’®ï¼Œè°ƒç”¨åˆ›å»ºæˆ–æ›´æ–° User çš„ API ã€‚

åˆ›å»ºæˆ–æ›´æ–° User ç•Œé¢

#createOrUpdateUser(UserPO) æ–¹æ³•ï¼Œåˆ›å»ºæˆ–æ›´æ–° User ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Autowired
private UserService userService;

@PreAuthorize(value = "@permissionValidator.isSuperAdmin()")
@RequestMapping(value = "/users", method = RequestMethod.POST)
public void createOrUpdateUser(@RequestBody UserPO user) {
    // æ ¡éªŒ `username` `password` éç©º
    if (StringUtils.isContainEmpty(user.getUsername(), user.getPassword())) {
        throw new BadRequestException("Username and password can not be empty.");
    }
    // æ–°å¢æˆ–æ›´æ–° User
    if (userService instanceof SpringSecurityUserService) {
        ((SpringSecurityUserService) userService).createOrUpdate(user);
    } else {
        throw new UnsupportedOperationException("Create or update user operation is unsupported");
    }
}
POST /users æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
@PreAuthorize(...) æ³¨è§£ï¼Œè°ƒç”¨ PermissionValidator#isSuperAdmin() æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚åç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚
è°ƒç”¨ SpringSecurityUserService#createOrUpdate(UserPO) æ–¹æ³•ï¼Œæ–°å¢æˆ–æ›´æ–° User ã€‚
5.2.2 logout
#logout(request, response) æ–¹æ³•ï¼ŒUser ç™»å‡ºã€‚ä»£ç å¦‚ä¸‹ï¼š

@Autowired
private LogoutHandler logoutHandler;

@RequestMapping(value = "/user/logout", method = RequestMethod.GET)
public void logout(HttpServletRequest request, HttpServletResponse response) throws IOException {
    logoutHandler.logout(request, response);
}
GET /user/logout æ¥å£ã€‚
è°ƒç”¨ LogoutHandler#logout(request, response) æ–¹æ³•ï¼Œç™»å‡º User ã€‚åœ¨ ã€Œ8. LogoutHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚



6. UserInfoHolder

com.ctrip.framework.apollo.portal.spi.UserInfoHolder ï¼Œè·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒSSO ä¸€èˆ¬éƒ½æ˜¯æŠŠå½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯æ”¾åœ¨çº¿ç¨‹ ThreadLocal ä¸Šã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface UserInfoHolder {

    UserInfo getUser();

}


6.1 SpringSecurityUserInfoHolder

com.ctrip.framework.apollo.portal.spi.springsecurity.SpringSecurityUserInfoHolder ï¼Œå®ç° UserInfoHolder æ¥å£ï¼ŒåŸºäº Spring Security çš„ UserInfoHolder å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

public class SpringSecurityUserInfoHolder implements UserInfoHolder {

    @Override
    public UserInfo getUser() {
        // åˆ›å»º UserInfo å¯¹è±¡ï¼Œè®¾ç½® `username` åˆ° `UserInfo.userId` ä¸­ã€‚
        UserInfo userInfo = new UserInfo();
        userInfo.setUserId(getCurrentUsername());
        return userInfo;
    }


    private String getCurrentUsername() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof UserDetails) {
            return ((UserDetails) principal).getUsername();
        }
        if (principal instanceof Principal) {
            return ((Principal) principal).getName();
        }
        return String.valueOf(principal);
    }
}



7. SsoHeartbeatHandler

com.ctrip.framework.apollo.portal.spi.SsoHeartbeatHandler

Portal é¡µé¢å¦‚æœé•¿æ—¶é—´ä¸åˆ·æ–°ï¼Œç™»å½•ä¿¡æ¯ä¼šè¿‡æœŸã€‚é€šè¿‡æ­¤æ¥å£æ¥åˆ·æ–°ç™»å½•ä¿¡æ¯

public interface SsoHeartbeatHandler {

    void doHeartbeat(HttpServletRequest request, HttpServletResponse response);

}



7.1 DefaultSsoHeartbeatHandler

com.ctrip.framework.apollo.portal.spi.defaultimpl.DefaultSsoHeartbeatHandler ï¼Œå®ç° SsoHeartbeatHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

public class DefaultSsoHeartbeatHandler implements SsoHeartbeatHandler {

    @Override
    public void doHeartbeat(HttpServletRequest request, HttpServletResponse response) {
        try {
            response.sendRedirect("default_sso_heartbeat.html");
        } catch (IOException e) {
        }
    }

}


è·³è½¬åˆ° default_sso_heartbeat.html ä¸­ã€‚é¡µé¢å¦‚ä¸‹ï¼š

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSO Heartbeat</title>
    <script type="text/javascript">
        var reloading = false;
        setInterval(function () {
            if (reloading) {
                return;
            }
            reloading = true;
            location.reload(true);
        }, 60000);
    </script>
</head>
<body>
</body>
</html>


æ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡é¡µé¢ã€‚ğŸ™‚ ä¸€è„¸æ‡µé€¼ï¼Œè¿™æ˜¯å¹²å•¥çš„ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹~



7.2 SsoHeartbeatController

com.ctrip.framework.apollo.portal.controller.SsoHeartbeatController ï¼Œä»£ç å¦‚ä¸‹ï¼š

@Controller
@RequestMapping("/sso_heartbeat")
public class SsoHeartbeatController {

    @Autowired
    private SsoHeartbeatHandler handler;

    @RequestMapping(value = "", method = RequestMethod.GET)
    public void heartbeat(HttpServletRequest request, HttpServletResponse response) {
        handler.doHeartbeat(request, response);
    }

}


é€šè¿‡æ‰“å¼€ä¸€ä¸ªæ–°çš„çª—å£ï¼Œè®¿é—® http://ip:prot/sso_hearbeat åœ°å€ï¼Œæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡é¡µé¢ï¼Œä»è€Œé¿å… SSO ç™»é™†è¿‡æœŸã€‚

å› æ­¤ï¼Œç›¸å…³ç±»çš„ç±»åéƒ½åŒ…å« Heartbeat ï¼Œä»£è¡¨å¿ƒè·³çš„æ„æ€ã€‚



8. LogoutHandler

com.ctrip.framework.apollo.portal.spi.LogoutHandler ï¼Œç”¨æ¥å®ç°ç™»å‡ºåŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface LogoutHandler {

    void logout(HttpServletRequest request, HttpServletResponse response);

}


8.1 DefaultLogoutHandler

com.ctrip.framework.apollo.portal.spi.defaultimpl.DefaultLogoutHandler ï¼Œå®ç° LogoutHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

public class DefaultLogoutHandler implements LogoutHandler {

    @Override
    public void logout(HttpServletRequest request, HttpServletResponse response) {
        try {
            response.sendRedirect("/");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

}

åœ¨ä½¿ç”¨ Spring Security çš„è¯·æ¬¾ä¸‹ï¼Œä¸ä¼šè°ƒç”¨åˆ°ã€‚æ³¨æ„ï¼Œå› ä¸ºï¼Œæˆ‘ä»¬é…ç½®äº†ç™»å‡ºé¡µã€‚

ã€Šã€Springã€‘å…³äºBootåº”ç”¨ä¸­é›†æˆSpring Securityä½ å¿…é¡»äº†è§£çš„é‚£äº›äº‹ã€‹

ã€Šå¾é–å³°å¤§å½©ç¬” â€”â€” Spring Securityã€‹


================================================================================================================


1. æ¦‚è¿°
è€è‰¿è‰¿ï¼šæœ¬ç³»åˆ—å‡å®šèƒ–å‹å·²ç»é˜…è¯»è¿‡ ã€ŠApollo å®˜æ–¹ wiki æ–‡æ¡£ã€‹ ï¼Œç‰¹åˆ«æ˜¯ ã€ŠPortal å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ã€‹ ã€‚

æœ¬æ–‡åˆ†äº« Portal çš„è®¤è¯ä¸æˆæƒï¼Œä¾§é‡åœ¨è®¤è¯éƒ¨åˆ†ã€‚

åœ¨ ã€ŠPortal å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ã€‹ æ–‡æ¡£çš„å¼€å¤´ï¼š

Apollo æ˜¯é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œä¼šæä¾›æƒé™ç®¡ç†ï¼ˆAuthorizationï¼‰ï¼Œç†è®ºä¸Šæ˜¯ä¸è´Ÿè´£ç”¨æˆ·ç™»å½•è®¤è¯åŠŸèƒ½çš„å®ç°ï¼ˆAuthenticationï¼‰ã€‚

æ‰€ä»¥ Apollo å®šä¹‰äº†ä¸€äº›SPIç”¨æ¥è§£è€¦ï¼ŒApollo æ¥å…¥ç™»å½•çš„å…³é”®å°±æ˜¯å®ç°è¿™äº› SPI ã€‚

å’Œæˆ‘ä»¬ç†è§£çš„ JDK SPI ä¸åŒï¼ŒApollo æ˜¯åŸºäº Spring Profile çš„ç‰¹æ€§ï¼Œé…åˆä¸Š Spring Java Configuration å®ç°äº†ç±»ä¼¼ SPI çš„åŠŸèƒ½ã€‚å¯¹äºå¤§å¤šæ•°äººï¼Œæˆ‘ä»¬å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„æ˜¯ï¼ŒåŸºäºä¸åŒçš„ Profile åŠ è½½ä¸åŒç¯å¢ƒçš„ yaml æˆ– properties é…ç½®æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œå½“ç¬”è€…çœ‹åˆ°è¿™æ ·çš„ç©æ³•ï¼Œä¹Ÿæ˜¯çœ¼å‰ä¸€äº®ã€‚

åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œspi åŒ…ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®¤è¯ç›¸å…³çš„é…ç½®ä¸å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šä»£ç ç»“æ„

ç»¿æ¡†ï¼šæ¥å£ã€‚
ç´«æ¡†ï¼šå®ç°ã€‚
çº¢æ¡†ï¼šé…ç½®æ¥å£å¯¹åº”çš„å®ç°ã€‚
2. AuthConfiguration
com.ctrip.framework.apollo.portal.spi.configuration.AuthConfiguration ï¼Œè®¤è¯ Spring Java é…ç½®ã€‚å¦‚ä¸‹å›¾ï¼šAuthConfiguration

ç›®å‰æœ‰ä¸‰ç§å®ç°ï¼š

ç¬¬ä¸€ç§ï¼Œ profile=ctrip ï¼Œæºç¨‹å†…éƒ¨å®ç°ï¼Œæ¥å…¥äº†SSOå¹¶å®ç°ç”¨æˆ·æœç´¢ã€æŸ¥è¯¢æ¥å£ã€‚
ç¬¬äºŒç§ï¼Œprofile=auth ï¼Œä½¿ç”¨ Apollo æä¾›çš„ Spring Security ç®€å•è®¤è¯ã€‚
ç¬¬ä¸‰ç§ï¼Œprofile ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å®ç°ï¼Œå…¨å±€åªæœ‰ apollo ä¸€ä¸ªè´¦å·ã€‚
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§ï¼ŒåŸºäº Spring Security çš„å®ç°ã€‚æ‰€ä»¥æœ¬æ–‡ä»…åˆ†äº«è¿™ç§æ–¹å¼ã€‚å¯¹å…¶ä»–æ–¹å¼æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±è¯»ä¸‹ä»£ç å“ˆã€‚

æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼šç±»å›¾

2.1 SpringSecurityAuthAutoConfiguration
UserService ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(UserService.class)
public UserService springSecurityUserService() {
    return new SpringSecurityUserService();
}
ä½¿ç”¨ SpringSecurityUserService å®ç°ç±»ï¼Œåœ¨ ã€Œ5. UserServiceã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
UserInfoHolder ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(UserInfoHolder.class)
public UserInfoHolder springSecurityUserInfoHolder() {
    return new SpringSecurityUserInfoHolder();
}
ä½¿ç”¨ SpringSecurityUserInfoHolder å®ç°ç±»ï¼Œåœ¨ ã€Œ6. UserInfoHolderã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
JdbcUserDetailsManager ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
public JdbcUserDetailsManager jdbcUserDetailsManager(AuthenticationManagerBuilder auth, DataSource datasource) throws Exception {
    JdbcUserDetailsManager jdbcUserDetailsManager = auth.jdbcAuthentication() // åŸºäº JDBC
            .passwordEncoder(new BCryptPasswordEncoder()) // åŠ å¯†æ–¹å¼ä¸º BCryptPasswordEncoder
            .dataSource(datasource) // æ•°æ®æº
            .usersByUsernameQuery("select Username,Password,Enabled from `Users` where Username = ?") // ä½¿ç”¨ Username æŸ¥è¯¢ User
            .authoritiesByUsernameQuery("select Username,Authority from `Authorities` where Username = ?") // ä½¿ç”¨ Username æŸ¥è¯¢ Authorities
            .getUserDetailsService();

    jdbcUserDetailsManager.setUserExistsSql("select Username from `Users` where Username = ?"); // åˆ¤æ–­ User æ˜¯å¦å­˜åœ¨
    jdbcUserDetailsManager.setCreateUserSql("insert into `Users` (Username, Password, Enabled) values (?,?,?)"); // æ’å…¥ User
    jdbcUserDetailsManager.setUpdateUserSql("update `Users` set Password = ?, Enabled = ? where Username = ?"); // æ›´æ–° User
    jdbcUserDetailsManager.setDeleteUserSql("delete from `Users` where Username = ?"); // åˆ é™¤ User
    jdbcUserDetailsManager.setCreateAuthoritySql("insert into `Authorities` (Username, Authority) values (?,?)"); // æ’å…¥ Authorities
    jdbcUserDetailsManager.setDeleteUserAuthoritiesSql("delete from `Authorities` where Username = ?"); // åˆ é™¤ Authorities
    jdbcUserDetailsManager.setChangePasswordSql("update `Users` set Password = ? where Username = ?"); // æ›´æ–° Authorities

    return jdbcUserDetailsManager;
}
org.springframework.security.provisioning.JdbcUserDetailsManager ï¼Œç»§æ‰¿ JdbcDaoImpl çš„åŠŸèƒ½ï¼Œæä¾›äº†ä¸€äº›å¾ˆæœ‰ç”¨çš„ä¸ Users å’Œ Authorities è¡¨ç›¸å…³çš„æ–¹æ³•ã€‚
èƒ–å‹å…ˆçœ‹ä¸‹ ã€Œ3. Usersã€ å’Œ ã€Œ4. Authoritiesã€ å°èŠ‚ï¼Œç„¶åå›è¿‡å¤´ç»§ç»­å¾€ä¸‹çœ‹ã€‚
SsoHeartbeatHandler ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(SsoHeartbeatHandler.class)
public SsoHeartbeatHandler defaultSsoHeartbeatHandler() {
    return new DefaultSsoHeartbeatHandler();
}
ä½¿ç”¨ DefaultSsoHeartbeatHandler å®ç°ç±»ï¼Œåœ¨ ã€Œ7. SsoHeartbeatHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
LogoutHandler ï¼Œé…ç½®å¦‚ä¸‹ï¼š

@Bean
@ConditionalOnMissingBean(LogoutHandler.class)
public LogoutHandler logoutHandler() {
    return new DefaultLogoutHandler();
}
ä½¿ç”¨ DefaultLogoutHandler å®ç°ç±»ï¼Œåœ¨ ã€Œ8. LogoutHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
2.2 SpringSecurityConfigureration
@Order(99)
@Profile("auth")
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
static class SpringSecurityConfigurer extends WebSecurityConfigurerAdapter {

    public static final String USER_ROLE = "user";

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable(); // å…³é—­æ‰“å¼€çš„ csrf ä¿æŠ¤
        http.headers().frameOptions().sameOrigin(); // ä»…å…è®¸ç›¸åŒ origin è®¿é—®
        http.authorizeRequests()
                .antMatchers("/openapi
    @Id
    @GeneratedValue
    @Column(name = "Id")
    private long id;

    @Column(name = "Username", nullable = false)
    private String username;

    @Column(name = "Password", nullable = false)
    private String password;

    @Column(name = "Email", nullable = false)
    private String email;

    @Column(name = "Enabled", nullable = false)
    private int enabled;

}
å­—æ®µæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚
3.1 UserInfo
com.ctrip.framework.apollo.portal.entity.bo.UserInfo ï¼ŒUser BO ã€‚ä»£ç å¦‚ä¸‹ï¼š

public class UserInfo {


    private String userId;

    private String name;

    private String email;

}
åœ¨ UserPO çš„ #toUserInfo() æ–¹æ³•ä¸­ï¼Œå°† UserPO è½¬æ¢æˆ UserBO ï¼Œä»£ç å¦‚ä¸‹ï¼š

public UserInfo toUserInfo() {
    UserInfo userInfo = new UserInfo();
    userInfo.setName(this.getUsername());
    userInfo.setUserId(this.getUsername());
    userInfo.setEmail(this.getEmail());
    return userInfo;
}
æ³¨æ„ï¼ŒuserId å’Œ name å±æ€§ï¼Œéƒ½æ˜¯æŒ‡å‘ User.username ã€‚
4. Authorities
Authorities è¡¨ï¼ŒSpring Security ä¸­çš„ Authority ï¼Œå®é™…å’Œ Role è§’è‰²ç­‰ä»·ã€‚è¡¨ç»“æ„å¦‚ä¸‹ï¼š

`Id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢Id',
`Username` varchar(50) NOT NULL,
`Authority` varchar(50) NOT NULL,
ç›®å‰ Portal åªæœ‰ä¸€ç§è§’è‰² "ROLE_user" ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šAuthorities
ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„å‘¢ï¼Ÿåœ¨ Apollo ä¸­ï¼Œ
ç»Ÿä¸€çš„ URL çš„æƒé™æ ¡éªŒï¼Œåªåˆ¤æ–­æ˜¯å¦ä¸ºç™»é™†ç”¨æˆ·ï¼Œåœ¨ SpringSecurityConfigureration ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚
å…·ä½“æ¯ä¸ª URL çš„æƒé™æ ¡éªŒï¼Œé€šè¿‡åœ¨å¯¹åº”çš„æ–¹æ³•ä¸Šï¼Œæ·»åŠ  @PreAuthorize æ–¹æ³•æ³¨è§£ï¼Œé…åˆå…·ä½“çš„æ–¹æ³•å‚æ•°ï¼Œä¸€èµ·æ ¡éªŒåŠŸèƒ½ + æ•°æ®çº§çš„æƒé™æ ¡éªŒã€‚
5. UserService
com.ctrip.framework.apollo.portal.spi.UserService ï¼ŒUser æœåŠ¡æ¥å£ï¼Œç”¨æ¥ç»™ Portal æä¾›ç”¨æˆ·æœç´¢ç›¸å…³åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface UserService {

    List<UserInfo> searchUsers(String keyword, int offset, int limit);

    UserInfo findByUserId(String userId);

    List<UserInfo> findByUserIds(List<String> userIds);

}
5.1 SpringSecurityUserService
com.ctrip.framework.apollo.portal.spi.springsecurity.SpringSecurityUserService ï¼ŒåŸºäº Spring Security çš„ UserService å®ç°ç±»ã€‚

5.5.1 æ„é€ æ–¹æ³•
private PasswordEncoder encoder = new BCryptPasswordEncoder();

private List<GrantedAuthority> authorities;

@Autowired
private JdbcUserDetailsManager userDetailsManager;
@Autowired
private UserRepository userRepository;

@PostConstruct
public void init() {
    authorities = new ArrayList<>();
    authorities.add(new SimpleGrantedAuthority("ROLE_user"));
}
authorities å±æ€§ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¸º "ROLE_user" ã€‚
5.5.2 createOrUpdate
#createOrUpdate(UserPO) æ–¹æ³•ï¼Œåˆ›å»ºæˆ–æ›´æ–° User ã€‚ä»£ç å¦‚ä¸‹ï¼š

 1: @Transactional
 2: public void createOrUpdate(UserPO user) {
 3:     String username = user.getUsername();
 4:     // åˆ›å»º Spring Security User
 5:     User userDetails = new User(username, encoder.encode(user.getPassword()), authorities);
 6:     // è‹¥å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ›´æ–°
 7:     if (userDetailsManager.userExists(username)) {
 8:         userDetailsManager.updateUser(userDetails);
 9:     // è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ–°å¢
10:     } else {
11:         userDetailsManager.createUser(userDetails);
12:     }
13:     // æ›´æ–°é‚®ç®±
14:     UserPO managedUser = userRepository.findByUsername(username);
15:     managedUser.setEmail(user.getEmail());
16:     userRepository.save(managedUser);
17: }
ç¬¬ 5 è¡Œï¼šåˆ›å»º com.ctrip.framework.apollo.portal.spi.springsecurity.User å¯¹è±¡ã€‚
ä½¿ç”¨ PasswordEncoder å¯¹ password åŠ å¯†ã€‚
ä¼ å…¥å¯¹åº”çš„è§’è‰² authorities å‚æ•°ã€‚
ç¬¬ 6 è‡³ 12 è¡Œï¼šæ–°å¢æˆ–æ›´æ–° User ã€‚
ç¬¬ 13 è‡³ 16 è¡Œï¼šæ›´æ–° email ã€‚ä¸ç›´æ¥åœ¨ã€ç¬¬ 6 è‡³ 12 è¡Œã€‘å¤„ç†çš„åŸå› æ˜¯ï¼Œcom.ctrip.framework.apollo.portal.spi.springsecurity.User ä¸­æ²¡æœ‰ email å±æ€§ã€‚
5.5.3 å…¶ä»–å®ç°æ–¹æ³•
ğŸ™‚ èƒ–å‹è‡ªå·±æŸ¥çœ‹ä»£ç ã€‚å˜¿å˜¿ã€‚

5.2 UserInfoController
åœ¨ apollo-portal é¡¹ç›®ä¸­ï¼Œcom.ctrip.framework.apollo.portal.controller.UserInfoController ï¼Œæä¾› User çš„ API ã€‚

5.2.1 createOrUpdateUser
åœ¨ç”¨æˆ·ç®¡ç†çš„ç•Œé¢ä¸­ï¼Œç‚¹å‡»ã€æäº¤ã€‘æŒ‰é’®ï¼Œè°ƒç”¨åˆ›å»ºæˆ–æ›´æ–° User çš„ API ã€‚

åˆ›å»ºæˆ–æ›´æ–° User ç•Œé¢

#createOrUpdateUser(UserPO) æ–¹æ³•ï¼Œåˆ›å»ºæˆ–æ›´æ–° User ã€‚ä»£ç å¦‚ä¸‹ï¼š

@Autowired
private UserService userService;

@PreAuthorize(value = "@permissionValidator.isSuperAdmin()")
@RequestMapping(value = "/users", method = RequestMethod.POST)
public void createOrUpdateUser(@RequestBody UserPO user) {
    // æ ¡éªŒ `username` `password` éç©º
    if (StringUtils.isContainEmpty(user.getUsername(), user.getPassword())) {
        throw new BadRequestException("Username and password can not be empty.");
    }
    // æ–°å¢æˆ–æ›´æ–° User
    if (userService instanceof SpringSecurityUserService) {
        ((SpringSecurityUserService) userService).createOrUpdate(user);
    } else {
        throw new UnsupportedOperationException("Create or update user operation is unsupported");
    }
}
POST /users æ¥å£ï¼ŒRequest Body ä¼ é€’ JSON å¯¹è±¡ã€‚
@PreAuthorize(...) æ³¨è§£ï¼Œè°ƒç”¨ PermissionValidator#isSuperAdmin() æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚åç»­æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚
è°ƒç”¨ SpringSecurityUserService#createOrUpdate(UserPO) æ–¹æ³•ï¼Œæ–°å¢æˆ–æ›´æ–° User ã€‚
5.2.2 logout
#logout(request, response) æ–¹æ³•ï¼ŒUser ç™»å‡ºã€‚ä»£ç å¦‚ä¸‹ï¼š

@Autowired
private LogoutHandler logoutHandler;

@RequestMapping(value = "/user/logout", method = RequestMethod.GET)
public void logout(HttpServletRequest request, HttpServletResponse response) throws IOException {
    logoutHandler.logout(request, response);
}
GET /user/logout æ¥å£ã€‚
è°ƒç”¨ LogoutHandler#logout(request, response) æ–¹æ³•ï¼Œç™»å‡º User ã€‚åœ¨ ã€Œ8. LogoutHandlerã€ ä¸­ï¼Œè¯¦ç»†è§£æã€‚
6. UserInfoHolder
com.ctrip.framework.apollo.portal.spi.UserInfoHolder ï¼Œè·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒSSO ä¸€èˆ¬éƒ½æ˜¯æŠŠå½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯æ”¾åœ¨çº¿ç¨‹ ThreadLocal ä¸Šã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface UserInfoHolder {

    UserInfo getUser();

}
6.1 SpringSecurityUserInfoHolder
com.ctrip.framework.apollo.portal.spi.springsecurity.SpringSecurityUserInfoHolder ï¼Œå®ç° UserInfoHolder æ¥å£ï¼ŒåŸºäº Spring Security çš„ UserInfoHolder å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

public class SpringSecurityUserInfoHolder implements UserInfoHolder {

    @Override
    public UserInfo getUser() {
        // åˆ›å»º UserInfo å¯¹è±¡ï¼Œè®¾ç½® `username` åˆ° `UserInfo.userId` ä¸­ã€‚
        UserInfo userInfo = new UserInfo();
        userInfo.setUserId(getCurrentUsername());
        return userInfo;
    }


    private String getCurrentUsername() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof UserDetails) {
            return ((UserDetails) principal).getUsername();
        }
        if (principal instanceof Principal) {
            return ((Principal) principal).getName();
        }
        return String.valueOf(principal);
    }

}
7. SsoHeartbeatHandler
com.ctrip.framework.apollo.portal.spi.SsoHeartbeatHandler ï¼ŒPortal é¡µé¢å¦‚æœé•¿æ—¶é—´ä¸åˆ·æ–°ï¼Œç™»å½•ä¿¡æ¯ä¼šè¿‡æœŸã€‚é€šè¿‡æ­¤æ¥å£æ¥åˆ·æ–°ç™»å½•ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface SsoHeartbeatHandler {

    void doHeartbeat(HttpServletRequest request, HttpServletResponse response);

}
7.1 DefaultSsoHeartbeatHandler
com.ctrip.framework.apollo.portal.spi.defaultimpl.DefaultSsoHeartbeatHandler ï¼Œå®ç° SsoHeartbeatHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

public class DefaultSsoHeartbeatHandler implements SsoHeartbeatHandler {

    @Override
    public void doHeartbeat(HttpServletRequest request, HttpServletResponse response) {
        try {
            response.sendRedirect("default_sso_heartbeat.html");
        } catch (IOException e) {
        }
    }

}
è·³è½¬åˆ° default_sso_heartbeat.html ä¸­ã€‚é¡µé¢å¦‚ä¸‹ï¼š

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSO Heartbeat</title>
    <script type="text/javascript">
        var reloading = false;
        setInterval(function () {
            if (reloading) {
                return;
            }
            reloading = true;
            location.reload(true);
        }, 60000);
    </script>
</head>
<body>
</body>
</html>
æ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡é¡µé¢ã€‚ğŸ™‚ ä¸€è„¸æ‡µé€¼ï¼Œè¿™æ˜¯å¹²å•¥çš„ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ã€‚
7.2 SsoHeartbeatController
com.ctrip.framework.apollo.portal.controller.SsoHeartbeatController ï¼Œä»£ç å¦‚ä¸‹ï¼š

@Controller
@RequestMapping("/sso_heartbeat")
public class SsoHeartbeatController {

    @Autowired
    private SsoHeartbeatHandler handler;

    @RequestMapping(value = "", method = RequestMethod.GET)
    public void heartbeat(HttpServletRequest request, HttpServletResponse response) {
        handler.doHeartbeat(request, response);
    }

}
é€šè¿‡æ‰“å¼€ä¸€ä¸ªæ–°çš„çª—å£ï¼Œè®¿é—® http://ip:prot/sso_hearbeat åœ°å€ï¼Œæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡é¡µé¢ï¼Œä»è€Œé¿å… SSO ç™»é™†è¿‡æœŸã€‚å› æ­¤ï¼Œç›¸å…³ç±»çš„ç±»åéƒ½åŒ…å« Heartbeat ï¼Œä»£è¡¨å¿ƒè·³çš„æ„æ€ã€‚
8. LogoutHandler
com.ctrip.framework.apollo.portal.spi.LogoutHandler ï¼Œç”¨æ¥å®ç°ç™»å‡ºåŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š

public interface LogoutHandler {

    void logout(HttpServletRequest request, HttpServletResponse response);

}
8.1 DefaultLogoutHandler
com.ctrip.framework.apollo.portal.spi.defaultimpl.DefaultLogoutHandler ï¼Œå®ç° LogoutHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

public class DefaultLogoutHandler implements LogoutHandler {

    @Override
    public void logout(HttpServletRequest request, HttpServletResponse response) {
        try {
            response.sendRedirect("/");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

}
ç™»å‡ºåï¼Œè·³è½¬åˆ° / åœ°å€ã€‚
ğŸ˜ˆ åœ¨ä½¿ç”¨ Spring Security çš„è¯·æ¬¾ä¸‹ï¼Œä¸ä¼šè°ƒç”¨åˆ°ã€‚æ³¨æ„ï¼Œå› ä¸ºï¼Œæˆ‘ä»¬é…ç½®äº†ç™»å‡ºé¡µã€‚

=======================================================================================

è°ƒè¯•ç¯å¢ƒæ­å»º

1. ä¾èµ–å·¥å…·
è€è‰¿è‰¿ï¼šæœ¬æ–‡å‚è€ƒ ã€ŠApollo å®˜æ–¹æ–‡æ¡£ â€”â€” å¼€å‘æŒ‡å—ã€‹ ï¼Œè¿›è¡Œç²¾ç®€ã€‚
å®˜æ–¹å¾ˆè‰¯å¿ƒï¼Œæ–‡æ¡£å¾ˆç»†å¿ƒã€‚

å»ºè®®èƒ–å‹åé¢é˜…è¯» Apollo è®¾è®¡æ–‡æ¡£ï¼š

ã€ŠApollo é…ç½®ä¸­å¿ƒä»‹ç»ã€‹
ã€ŠApollo é…ç½®ä¸­å¿ƒè®¾è®¡ã€‹
ã€ŠApolloæ ¸å¿ƒæ¦‚å¿µä¹‹â€œNamespaceâ€ã€‹
JDK ï¼š1.8+
MySQL ï¼š5.6.5+
Maven
IntelliJ IDEA
2. åˆ›å»ºæ•°æ®åº“
Apollo æœåŠ¡ç«¯å…±æœ‰ä¸¤ä¸ªæ•°æ®åº“ï¼š

ApolloPortalDB
ApolloConfigDB
åœ¨Apollo é¡¹ç›®ä¸‹çš„scripts` ç›®å½•ï¼Œæä¾›äº†å¯¹åº”çš„åˆå§‹åŒ–è„šæœ¬ï¼šscripts

2.1 åˆ›å»º ApolloPortalDB
é€šè¿‡å„ç§ MySQL å®¢æˆ·ç«¯å¯¼å…¥ sql/apolloportaldb.sql è„šæœ¬ã€‚ä¾‹å¦‚ç¬”è€…å–œæ¬¢ç”¨ Navicat ã€‚

åŸºæƒ…æç¤ºï¼šNavicat å¯¼å…¥ SQL è„šæœ¬ï¼Œå¯é˜…è¯»æ–‡ç« ï¼šã€Šnavicaté‡Œå¯¼å…¥å’Œå¯¼å‡º.sqlæ–‡ä»¶ã€‹ ã€‚

å¯¼å…¥æˆåŠŸåï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼šè¡¨ç»“æ„

2.2 åˆ›å»º ApolloConfigDB
é€šè¿‡å„ç§ MySQL å®¢æˆ·ç«¯å¯¼å…¥ sql/apolloconfigdb.sql è„šæœ¬ã€‚

å¯¼å…¥æˆåŠŸåï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼šè¡¨ç»“æ„

3. ConfigService && AdminService
åŒæ—¶å¯åŠ¨ apollo-adminservice å’Œ apollo-configservice é¡¹ç›®ï¼ŒåŸºäº apollo-assembly é¡¹ç›®æ¥å¯åŠ¨ã€‚

1ã€æ–°å»º IDEA Application æ–°å»º Application

2ã€é…ç½® IDEA Application é…ç½® Application

Main class ï¼šcom.ctrip.framework.apollo.assembly.ApolloApplication ã€‚
VM options ï¼š

-Dapollo_profile=github
-Dspring.datasource.url=jdbc:mysql://localhost:33061/ApolloConfigDB? characterEncoding=utf8
-Dspring.datasource.username=root
-Dspring.datasource.password=123456
-Dlogging.file=/Users/yunai/apollo-assembly.log

spring.datasource é…ç½®è¿æ¥ ApolloConfigDB æ•°æ®åº“ã€‚
loggine.file é…ç½®æ—¥å¿—è¾“å‡ºæ–‡ä»¶ã€‚
Use classpath of module ï¼šapollo-assembly ã€‚

3ã€å¯åŠ¨ IDEA Application å¯åŠ¨ Application

å¯åŠ¨æ—¶é—´éœ€è¦ 3 åˆ†é’Ÿå·¦å³ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å½“æ‰“å¼€ http://localhost:8080/ çœ‹åˆ° APOLLO-ADMINSERVICE å’Œ APOLLO-CONFIGSERVICE æ³¨å†Œåˆ° Eureka ä¸­ï¼Œä»£è¡¨å¯åŠ¨æˆåŠŸã€‚http://localhost:8080/

4. PortalService
1ã€æ–°å»º IDEA Application

2ã€é…ç½® IDEA Application é…ç½® Application

Main class ï¼šcom.ctrip.framework.apollo.portal.PortalApplication ã€‚
VM options ï¼š

-Dapollo_profile=github,auth
-Ddev_meta=http://localhost:8080/
-Dserver.port=8070
-Dspring.datasource.url=jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding=utf8
-Dspring.datasource.username=root
-Dspring.datasource.password=
-Dlogging.file=/Users/yunai/apollo-portal.log

spring.datasource é…ç½®è¿æ¥ ApolloPortalDB æ•°æ®åº“ã€‚
loggine.file é…ç½®æ—¥å¿—è¾“å‡ºæ–‡ä»¶ã€‚
Use classpath of module ï¼šapollo-portal ã€‚

å†…ç½®è´¦å·

username ï¼šApollo
password ï¼šadmin
3ã€å¯åŠ¨ IDEA Application

å¯åŠ¨æ—¶é—´å¾ˆå¿«ã€‚å½“æ‰“å¼€ http://localhost:8070/ ã€‚http://localhost:8070/

5. Demo
è€ƒè™‘åˆ°ä¸‹é¢çš„æµ‹è¯•ï¼Œéœ€è¦åˆ›å»ºæµ‹è¯•çš„åº”ç”¨ï¼Œç¼–å·ä¸º 100004458 ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š100004458

1ã€æ–°å»º IDEA Application

2ã€é…ç½® IDEA Application é…ç½® Application

Main class ï¼šcom.ctrip.framework.apollo.demo.api.SimpleApolloConfigDemo ã€‚
VM options ï¼š

-Denv=dev
-Ddev_meta=http://localhost:8080

Use classpath of module ï¼šapollo-demo ã€‚

3ã€å¯åŠ¨ IDEA Application

æˆåŠŸåï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

Apollo Config Demo. Please input key to get the value. Input quit to exit.
è¾“å…¥ "timeout" ï¼Œå›è½¦ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

timeout> [apollo-demo][main]2018-04-22 11:12:43,345 INFO  [com.ctrip.framework.apollo.demo.api.SimpleApolloConfigDemo] Loading key : timeout with value: 6666
æ­¤å¤„ä¾¿æ˜¯æˆ‘ä»¬åœ¨ Apollo Portal ä¸­é…ç½®çš„ "timeout" å€¼ã€‚
666. å½©è›‹
å®˜æ–¹æ–‡æ¡£çœŸçš„æ˜¯å®Œå–„ã€‚æ­å»ºç¯å¢ƒ + å†™æ–‡ç« ï¼ŒåªèŠ±äº† 3 ä¸ªå°æ—¶å·¦å³ã€‚

å¦å¤–ï¼Œæœ¬æ–‡å†™çš„æ¯”è¾ƒç®€å•ï¼Œè¯¦ç»†çš„å»ºè®®å¤šçœ‹çœ‹å®˜æ–¹æ–‡æ¡£ã€‚








